<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>12æœˆå†²åˆº Pro (ç»ˆæç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        :root { --primary: #3b82f6; --success: #10b981; }
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f6f8fa; -webkit-tap-highlight-color: transparent; }
        
        /* å“åº”å¼ç½‘æ ¼ç³»ç»Ÿ */
        .calendar-wrapper {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr; 
        }
        @media (min-width: 800px) {
            .calendar-wrapper {
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }
        }

        /* å¡ç‰‡æ ·å¼ */
        .day-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            min-height: 100px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            position: relative;
        }

        .is-past { background-color: #f9fafb; opacity: 0.8; }
        .is-past .task-item { opacity: 0.6; }
        
        .is-today { 
            background: #ffffff; 
            ring: 2px solid #3b82f6; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            z-index: 10;
        }

        /* ä»»åŠ¡æ¡æ ·å¼ */
        .task-item {
            font-size: 0.85rem;
            padding: 8px 10px 8px 30px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            line-height: 1.4;
            display: flex;
            align-items: center;
        }

        .task-item::before {
            content: '';
            position: absolute;
            left: 10px;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 4px;
            opacity: 0.4;
            transition: all 0.2s;
        }

        .task-item.done {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            border-color: transparent !important;
            text-decoration: line-through;
            transform: scale(0.98);
        }
        .task-item.done::before {
            background-color: #9ca3af;
            border-color: #9ca3af;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
        }

        .t-pol { background: #fff1f2; color: #be123c; }
        .t-eng { background: #eff6ff; color: #1d4ed8; }
        .t-art { background: #fdf4ff; color: #86198f; }
        .t-the { background: #ecfdf5; color: #047857; }

        .note-trigger {
            opacity: 0.3;
            transition: 0.2s;
            padding: 4px;
        }
        .day-card:hover .note-trigger { opacity: 1; }
        .has-note .note-trigger { color: #f59e0b; opacity: 1; }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-shimmer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        /* ç§»åŠ¨ç«¯ç‰¹æ®Šä¼˜åŒ– */
        @media (max-width: 768px) {
            .week-header { display: none; }
            .day-card { 
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }
            .day-header-mobile {
                width: 100%;
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                border-bottom: 1px dashed #f3f4f6;
                padding-bottom: 8px;
            }
            .task-container { width: 100%; }
        }

        /* === æ¨¡æ€æ¡† === */
        .modal-overlay {
            background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(4px);
            opacity: 0; 
            pointer-events: none; 
            transition: 0.3s; 
            position: fixed; 
            inset: 0; 
            z-index: 100;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white; 
            width: 90%; 
            max-width: 700px;
            border-radius: 20px;
            transform: scale(0.95) translateY(10px); 
            transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            max-height: 90vh;
        }
        .modal-overlay.open .modal-content { transform: scale(1) translateY(0); }

        /* ğŸ“± æ‰‹æœºç«¯æŠ½å±‰æ ·å¼ */
        @media (max-width: 768px) {
            .modal-overlay {
                align-items: flex-end; padding-bottom: 0;
            }
            .modal-content {
                width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; margin: 0;
                transform: translateY(100%); 
                height: 85vh; /* å›ºå®šé«˜åº¦ */
            }
            .modal-overlay.open .modal-content { transform: translateY(0); }
        }
        
        /* ğŸ“ æ»šåŠ¨å®¹å™¨æ ·å¼ */
        .editor-scroller {
            flex: 1;
            overflow-y: auto; /* æ»šåŠ¨æ¡åœ¨è¿™é‡Œ */
            -webkit-overflow-scrolling: touch; /* iOSä¸æ»‘æ»šåŠ¨ */
            position: relative;
            background: white;
            overscroll-behavior: contain; /* é˜²æ­¢æ»‘åˆ°åº•éƒ¨æ‹–åŠ¨èƒŒæ™¯ */
        }

        /* ğŸ“ å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
        #note-editor {
            width: 100%; 
            min-height: 100%; 
            padding: 24px;
            outline: none; 
            color: #334155; 
            font-size: 16px; 
            line-height: 1.6;
        }
        
        /* ç¼–è¾‘å™¨å†…éƒ¨æ ·å¼æ”¯æŒ */
        #note-editor img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #e2e8f0; }
        #note-editor table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
        #note-editor th, #note-editor td { border: 1px solid #cbd5e1; padding: 6px; text-align: left; }
        #note-editor th { background-color: #f1f5f9; font-weight: bold; }
        #note-editor ul { list-style-type: disc; padding-left: 20px; margin: 8px 0; }
        #note-editor ol { list-style-type: decimal; padding-left: 20px; margin: 8px 0; }
        #note-editor blockquote { border-left: 4px solid #3b82f6; padding-left: 12px; color: #64748b; margin: 8px 0; }
        #note-editor b, #note-editor strong { color: #0f172a; }
        
        /* â˜‘ï¸ ä»»åŠ¡æ¡†æ ·å¼ */
        #note-editor input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
            transform: scale(1.3); /* æ”¾å¤§ä¸€ç‚¹å¥½ç‚¹ */
            cursor: pointer;
            accent-color: #3b82f6; /* è“è‰²å‹¾é€‰ */
        }

        #note-editor:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            pointer-events: none;
            display: block; 
        }

        .sheet-handle { width: 40px; height: 4px; background: #e2e8f0; border-radius: 10px; margin: 8px auto 0; }
        
        .toolbar-btn {
            padding: 6px; border-radius: 4px; color: #64748b; transition: 0.2s;
        }
        .toolbar-btn:hover { background-color: #f1f5f9; color: #3b82f6; }
    </style>
</head>
<body class="pb-10">

    <div class="max-w-8xl mx-auto px-4 pt-6 md:pt-10">
        <!-- Header -->
        <div class="bg-white rounded-2xl p-6 mb-8 shadow-sm border border-slate-100 relative overflow-hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 relative z-10">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500 tracking-wider">DASHBOARD</span>
                        <div id="cloud-status-badge" class="flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] bg-slate-50 text-slate-400 border border-slate-100">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> ç¦»çº¿
                        </div>
                    </div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight">12æœˆå†²åˆºè®¡åˆ’</h1>
                    <p class="text-slate-400 text-sm mt-1 font-medium">Keep moving, stay focused.</p>
                </div>

                <div class="w-full md:w-auto flex flex-col gap-2">
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-1">
                        <span>å½“å‰è¿›åº¦</span>
                        <span id="progress-text" class="text-blue-600">0%</span>
                    </div>
                    <div class="w-full md:w-64 h-3 bg-slate-100 rounded-full overflow-hidden relative">
                        <div id="progress-fill" class="h-full bg-blue-500 rounded-full transition-all duration-700 relative overflow-hidden" style="width: 0%">
                            <div class="progress-shimmer"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-blue-50 to-transparent rounded-bl-full opacity-50 -z-0 pointer-events-none"></div>
        </div>

        <div class="hidden md:grid grid-cols-7 text-center mb-3 text-xs font-bold text-slate-400 week-header px-2">
            <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div><div>SUN</div>
        </div>

        <div class="calendar-wrapper" id="calendar-view">
            <!-- JS æ¸²æŸ“ -->
        </div>

        <div class="mt-12 text-center">
             <div class="inline-flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full text-[10px] text-slate-400 font-mono">
                <i class="fas fa-fingerprint"></i> ID: <span id="sync-id-label">LOCAL</span>
            </div>
        </div>
    </div>

    <!-- å¯Œæ–‡æœ¬ç¬”è®°å¼¹çª— -->
    <div id="note-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- æ‰‹æœºç«¯æŠŠæ‰‹ -->
            <div class="md:hidden w-full bg-white pt-2 pb-1 shrink-0" onclick="closeModal()">
                <div class="sheet-handle"></div>
            </div>

            <!-- å¤´éƒ¨ + å·¥å…·æ  -->
            <div class="bg-white px-4 py-3 border-b border-slate-100 flex flex-col gap-2 shrink-0">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
                        <h3 class="font-bold text-slate-800 text-lg">ğŸ“ <span id="modal-date-title"></span></h3>
                    </div>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center transition text-xl">&times;</button>
                </div>
                <!-- ç®€å•å·¥å…·æ  -->
                <div class="flex gap-2 bg-slate-50 p-1.5 rounded-lg w-max mt-1 overflow-x-auto no-scrollbar">
                    <button class="toolbar-btn" onclick="execCmd('bold')" title="åŠ ç²—"><i class="fas fa-bold"></i></button>
                    <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="åˆ—è¡¨"><i class="fas fa-list-ul"></i></button>
                    <button class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="æœ‰åºåˆ—è¡¨"><i class="fas fa-list-ol"></i></button>
                    <button class="toolbar-btn" onclick="insertCheckbox()" title="ä»»åŠ¡æ¡†"><i class="far fa-check-square"></i></button>
                    <div class="w-px bg-slate-200 mx-1"></div>
                    <span class="text-[10px] text-slate-400 flex items-center px-1 whitespace-nowrap">æ”¯æŒç²˜è´´æˆªå›¾/è¡¨æ ¼</span>
                </div>
            </div>
            
            <!-- ç¼–è¾‘åŒºåŸŸ (ContentEditable) - æ»šåŠ¨å®¹å™¨ç‹¬ç«‹ -->
            <div class="editor-scroller">
                <div id="note-editor" contenteditable="true" placeholder="åœ¨æ­¤ç²˜è´´æˆªå›¾ã€è¡¨æ ¼ï¼Œæˆ–è€…è®°å½•å¤ç›˜å¿ƒå¾—..."></div>
            </div>
            
            <!-- åº•éƒ¨ -->
            <div class="bg-white px-6 py-4 border-t border-slate-100 flex justify-end shrink-0">
                <button onclick="saveNote()" class="w-full md:w-auto bg-slate-900 hover:bg-black text-white px-8 py-3 rounded-xl text-sm font-bold shadow-lg shadow-slate-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-save"></i> ä¿å­˜ç¬”è®°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const MY_SYNC_ID = "my-study-id"; 
        const SUPABASE_URL = "https://atpywxgykzhgtzhdpqbe.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cHl3eGd5a3poZ3R6aGRwcWJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTAxNzYsImV4cCI6MjA4MDMyNjE3Nn0.UCd3qH2xpR7BpDFkCHUBkEgHXkj3uG1hUW-qMZ7Ys7s";
        // =========================================

        const calendarData = [
            { day: 1, past: true }, { day: 2, past: true },
            { day: 3, today: true, tasks: [
                { id: "t3_1", text: "è‚–å…«1-3å¥—é”™é¢˜äºŒåˆ·", type: "t-pol" },
                { id: "t3_2", text: "ç†è®º: åè¯è§£é‡Š(æµæ´¾)", type: "t-the" },
                { id: "t3_3", text: "æ•´ç†å¿«é¢˜ä¸‡èƒ½æ¨¡æ¿", type: "t-art" }
            ]},
            { day: 4, tasks: [
                { id: "t4_1", text: "è‚–å…«4-6å¥—é€‰æ‹©é¢˜", type: "t-pol" },
                { id: "t4_2", text: "è‹±è¯­å†™ä½œæ¨¡æ¿(å›¾è¡¨)", type: "t-eng" },
                { id: "t4_3", text: "ç†è®º: å¡«ç©ºé€‰æ‹©çªå‡»", type: "t-the" }
            ]},
            { day: 5, tasks: [
                { id: "t5_1", text: "è‚–å…«7-8å¥—(å¯é€‰)", type: "t-pol" },
                { id: "t5_2", text: "è‹±è¯­å†™ä½œæ¨¡æ¿(ä¹¦ä¿¡)", type: "t-eng" },
                { id: "t5_3", text: "æ™š: å±€éƒ¨çº¿ç¨¿x3", type: "t-art" }
            ]},
            { day: 6, tasks: [
                { id: "t6_1", text: "æ‰‹ç»˜3å°æ—¶æ¨¡æ‹Ÿ", type: "t-art" },
                { id: "t6_2", text: "è‚–å…«å…¨éƒ¨é”™é¢˜å¤ç›˜", type: "t-pol" }
            ]},
            { day: 7, tasks: [
                { id: "t7_1", text: "ç†è®ºæ¨¡è€ƒ", type: "t-the" },
                { id: "t7_2", text: "ä¸‹åˆ: è‹±è¯­å…¨çœŸæ¨¡æ‹Ÿ", type: "t-eng" }
            ]},
            { day: 8, tasks: [
                { id: "t8_1", text: "è‹±è¯­ä½œæ–‡æ¨¡æ¿ç†ŸèƒŒ", type: "t-eng" },
                { id: "t8_2", text: "æ‰‹ç»˜å¤ç›˜/æ”¹å›¾", type: "t-art" }
            ]},
            { day: 9, tasks: [
                { id: "t9_1", text: "ç†è®ºæ ¸å¿ƒåè¯çªå‡»", type: "t-the" },
                { id: "t9_2", text: "é©¬åŸåŸç†å›é¡¾", type: "t-pol" }
            ]},
            { day: 10, note: "è‚–å››åˆ°è´§!", special: true, tasks: [
                { id: "t10_1", text: "è‚–å››å·1+å·2é€‰æ‹©é¢˜", type: "t-pol" },
                { id: "t10_2", text: "èƒŒè‚–å››å·1å¤§é¢˜(æ­»èƒŒ)", type: "t-pol" }
            ]},
            { day: 11, tasks: [
                { id: "t11_1", text: "è‚–å››å·3+å·4é€‰æ‹©é¢˜", type: "t-pol" },
                { id: "t11_2", text: "èƒŒè‚–å››å·2å¤§é¢˜", type: "t-pol" }
            ]},
            { day: 12, tasks: [
                { id: "t12_1", text: "èƒŒè‚–å››å·3å¤§é¢˜", type: "t-pol" },
                { id: "t12_2", text: "è¿‘3å¹´é˜…è¯»çœŸé¢˜æ‰‹æ„Ÿ", type: "t-eng" }
            ]},
            { day: 13, tasks: [
                { id: "t13_1", text: "èƒŒè‚–å››å·4å¤§é¢˜", type: "t-pol" },
                { id: "t13_2", text: "äºŒåˆ·è‚–å››å…¨éƒ¨é€‰æ‹©é¢˜", type: "t-pol" }
            ]},
            { day: 14, tasks: [
                { id: "t14_1", text: "æœ€åä¸€å¼ å®Œæ•´å¿«é¢˜", type: "t-art" },
                { id: "t14_2", text: "ç†è®ºæŸ¥æ¼è¡¥ç¼º", type: "t-the" }
            ]},
            { day: 15, tasks: [
                { id: "t15_1", text: "è‚–å››å¤§é¢˜ç¬¬äºŒè½®", type: "t-pol" },
                { id: "t15_2", text: "æ‰“å°å…¥åœºå‡­è¯", type: "t-pol" }
            ]},
            { day: 16, note: "å»ºè®®è¯·å‡", tasks: [
                { id: "t16_1", text: "æ”¿æ²»é”™é¢˜+æ—¶æ”¿æ­»è§’", type: "t-pol" },
                { id: "t16_2", text: "ç†è®ºæ­»è§’æ‰«é™¤", type: "t-the" }
            ]},
            { day: 17, note: "å»ºè®®è¯·å‡", tasks: [
                { id: "t17_1", text: "ä½œæ–‡é»˜å†™æœ€åä¸€é", type: "t-eng" },
                { id: "t17_2", text: "çœ‹ä¼˜ç§€æ¡ˆä¾‹", type: "t-art" }
            ]},
            { day: 18, note: "å»ºè®®è¯·å‡", tasks: [
                { id: "t18_1", text: "è‚–å››æ»šç“œçƒ‚ç†Ÿ", type: "t-pol" },
                { id: "t18_2", text: "å…¨æµç¨‹è„‘ä¸Šæ¼”ç»ƒ", type: "t-art" }
            ]},
            { day: 19, tasks: [
                { id: "t19_1", text: "è¸©ç‚¹ / é…’åº—ç¡®è®¤", type: "t-pol" },
                { id: "t19_2", text: "22:00 ä¼‘æ¯", type: "t-pol" }
            ]},
            { day: 20, note: "Day 1", special: true, tasks: [
                { id: "t20_1", text: "ä¸Šåˆ: æ”¿æ²»", type: "t-pol" },
                { id: "t20_2", text: "ä¸‹åˆ: è‹±è¯­", type: "t-eng" }
            ]},
            { day: 21, note: "Day 2", special: true, tasks: [
                { id: "t21_1", text: "ä¸Šåˆ: ç†è®º", type: "t-the" },
                { id: "t21_2", text: "ä¸‹åˆ: æ‰‹ç»˜", type: "t-art" }
            ]}
        ];

        let supabaseClient = null;
        let isCloud = false;
        let state = { done: [], notes: {} };

        async function init() {
            render();
            document.getElementById('sync-id-label').innerText = MY_SYNC_ID;
            
            // Rich Text Paste Handler (å›¾ç‰‡è½¬Base64)
            const editor = document.getElementById('note-editor');
            editor.addEventListener('paste', function(e) {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.execCommand('insertImage', false, event.target.result);
                        };
                        reader.readAsDataURL(blob);
                        e.preventDefault(); 
                    }
                }
            });

            // Auto-persist checkboxes
            editor.addEventListener('change', (e) => {
                if(e.target.tagName === 'INPUT' && e.target.type === 'checkbox') {
                    e.target.checked ? e.target.setAttribute('checked', '') : e.target.removeAttribute('checked');
                }
            });

            if(SUPABASE_URL && SUPABASE_KEY) {
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    isCloud = true;
                    updateStatus('online');
                    await loadCloud();
                } catch(e) { console.error(e); loadLocal(); }
            } else { loadLocal(); }
        }

        async function save() {
            updateProgress();
            localStorage.setItem('study_v2', JSON.stringify(state));
            if(isCloud) {
                updateStatus('syncing');
                await supabaseClient.from('study_progress').upsert({ id: MY_SYNC_ID, data: state });
                updateStatus('online');
            }
        }

        async function loadCloud() {
            const { data } = await supabaseClient.from('study_progress').select('data').eq('id', MY_SYNC_ID).single();
            if(data?.data) { state = data.data; refresh(); } else { loadLocal(); }
        }

        function loadLocal() {
            const s = localStorage.getItem('study_v2');
            if(s) { state = JSON.parse(s); refresh(); }
        }

        function updateStatus(s) {
            const b = document.getElementById('cloud-status-badge');
            if(s==='online') b.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.6)]"></span> äº‘åŒæ­¥`;
            if(s==='syncing') b.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span> åŒæ­¥ä¸­`;
        }

        function render() {
            const root = document.getElementById('calendar-view');
            root.innerHTML = '';
            
            calendarData.forEach(d => {
                const card = document.createElement('div');
                card.className = `day-card ${d.past ? 'is-past' : ''} ${d.today ? 'is-today' : ''}`;
                if(d.special) card.style.background = "repeating-linear-gradient(45deg, #fff, #fff 10px, #fdf2f8 10px, #fdf2f8 20px)";
                card.id = `day-${d.day}`;

                const header = document.createElement('div');
                header.className = 'day-header-mobile md:w-full md:border-b-0 md:mb-2 md:pb-0 flex justify-between items-center';
                
                let label = `<span class="text-xl font-bold text-slate-700 font-mono">${d.day}</span>`;
                if(d.today) label += `<span class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">ä»Šå¤©</span>`;
                if(d.note) label += `<span class="ml-2 text-[10px] text-red-400 font-medium">${d.note}</span>`;
                
                header.innerHTML = `<div>${label}</div> <i class="fas fa-edit note-trigger hover:text-blue-500 cursor-pointer text-slate-300" onclick="openNote(${d.day})"></i>`;
                card.appendChild(header);

                const taskContainer = document.createElement('div');
                taskContainer.className = 'task-container w-full';
                
                if(d.tasks) {
                    d.tasks.forEach(t => {
                        const task = document.createElement('div');
                        task.className = `task-item ${t.type}`;
                        task.dataset.id = t.id;
                        task.innerHTML = t.text;
                        task.onclick = () => toggle(t.id);
                        taskContainer.appendChild(task);
                    });
                }
                card.appendChild(taskContainer);
                root.appendChild(card);
            });
        }

        function refresh() {
            document.querySelectorAll('.task-item').forEach(el => {
                if(state.done.includes(el.dataset.id)) el.classList.add('done');
                else el.classList.remove('done');
            });
            Object.keys(state.notes).forEach(k => {
                const d = k.replace('d','');
                const c = document.getElementById(`day-${d}`);
                if(c && state.notes[k]) c.classList.add('has-note');
                else if(c) c.classList.remove('has-note');
            });
            updateProgress();
        }

        window.toggle = (id) => {
            const i = state.done.indexOf(id);
            if(i > -1) state.done.splice(i, 1);
            else state.done.push(id);
            refresh();
            save();
        };

        // Rich Text Note Logic
        let curNoteDay = null;
        const modal = document.getElementById('note-modal');
        const editor = document.getElementById('note-editor');

        window.execCmd = (cmd) => {
            document.execCommand(cmd, false, null);
            editor.focus();
        }

        window.insertCheckbox = () => {
            const id = 'cb-' + Date.now();
            const html = `<input type="checkbox" id="${id}"> `;
            document.execCommand('insertHTML', false, html);
            editor.focus();
        };

        window.openNote = (d) => {
            curNoteDay = d;
            document.getElementById('modal-date-title').innerText = `12æœˆ${d}æ—¥`;
            // ä½¿ç”¨ innerHTML è¯»å–å¯Œæ–‡æœ¬å†…å®¹
            editor.innerHTML = state.notes[`d${d}`] || '';
            modal.classList.add('open');
            document.body.style.overflow = 'hidden'; 
            setTimeout(() => editor.focus(), 100);
        };
        window.closeModal = () => {
            modal.classList.remove('open');
            document.body.style.overflow = ''; 
        };
        window.saveNote = () => {
            // ä¿å­˜ HTML å†…å®¹
            const v = editor.innerHTML;
            // ç®€å•çš„é˜²ç©ºåˆ¤æ–­ï¼ˆå¦‚æœåªæœ‰ç©ºæ ‡ç­¾ä¹Ÿç®—ç©ºï¼‰
            if(v && v !== '<br>') state.notes[`d${curNoteDay}`] = v;
            else delete state.notes[`d${curNoteDay}`];
            refresh(); save(); closeModal();
        };

        function updateProgress() {
            const total = document.querySelectorAll('.task-item').length;
            const done = state.done.length;
            const p = total ? Math.round((done/total)*100) : 0;
            document.getElementById('progress-text').innerText = p + '%';
            document.getElementById('progress-fill').style.width = p + '%';
        }

        init();
    </script>
</body>
</html>
