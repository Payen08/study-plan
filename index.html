<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12ÊúàÂÜ≤Âà∫ (ÊûÅÁÆÄÁâà)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8fafc; user-select: none; }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        
        .day-cell {
            background-color: white;
            min-height: 120px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }

        .day-header {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #475569;
        }
        
        /* ‰ªªÂä°Êù° */
        .task-tag {
            font-size: 0.75rem;
            padding: 4px 8px 4px 24px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            line-height: 1.4;
            border: 1px solid transparent;
        }
        
        .task-tag::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border: 1.5px solid currentColor;
            border-radius: 3px;
            opacity: 0.5;
        }

        .task-tag:hover { filter: brightness(0.95); transform: translateY(-1px); }

        /* Types */
        .t-pol { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        .t-eng { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .t-art { background: #faf5ff; color: #7e22ce; border-color: #e9d5ff; }
        .t-the { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }

        /* Completed State */
        .task-tag.done {
            background: #f1f5f9 !important;
            color: #94a3b8 !important;
            border-color: #e2e8f0 !important;
            text-decoration: line-through;
            opacity: 0.7;
        }
        .task-tag.done::before {
            background-color: #94a3b8;
            border-color: #94a3b8;
            border: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
        }

        /* Note Button */
        .note-btn {
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
            border-radius: 4px;
        }
        .day-cell:hover .note-btn { color: #94a3b8; }
        .note-btn:hover { background-color: #eff6ff; color: #3b82f6 !important; }
        .has-note .note-btn { color: #f59e0b !important; opacity: 1; }

        /* Special Days */
        .is-today { background-color: #eff6ff; ring: 2px solid #3b82f6; z-index: 2; }
        .is-past { background-color: #f8fafc; }
        .is-past .day-header { opacity: 0.5; }
        .bg-xiao-arrival { background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fee2e2 10px, #fee2e2 20px); }

        @media (max-width: 768px) {
            .calendar-grid { display: flex; flex-direction: column; gap: 8px; border: none; background: transparent; }
            .day-cell { border-radius: 12px; border: 1px solid #e2e8f0; min-height: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .week-header { display: none; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: white; width: 90%; max-width: 500px;
            border-radius: 16px; transform: scale(0.95); transition: 0.3s;
            display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto">
        
        <!-- Header & Stats -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight flex items-center">
                    12ÊúàÂÜ≤Âà∫Êï∞ÊçÆ‰∏≠ÂøÉ
                    <!-- ‰∫ëÂêåÊ≠•ÊåáÁ§∫ÁÅØ -->
                    <span id="cloud-status" class="ml-2 w-2 h-2 rounded-full bg-slate-300" title="Á¶ªÁ∫øÊ®°Âºè"></span>
                </h1>
                <p class="text-slate-400 text-sm mt-1">ÂùöÊåÅÂ∞±ÊòØËÉúÂà©ÔºåÊï∞ÊçÆËá™Âä®‰øùÂ≠ò</p>
            </div>

            <div class="flex items-center gap-4 w-full md:w-auto bg-slate-50 p-3 rounded-xl border border-slate-100">
                <span class="text-slate-500 font-bold text-sm whitespace-nowrap">ÊÄªËøõÂ∫¶ <span id="progress-val" class="text-slate-800">0%</span></span>
                <div class="w-full md:w-48 h-2.5 bg-slate-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex gap-3 mb-4 text-xs font-bold text-slate-500 justify-end">
            <span class="flex items-center"><span class="w-2 h-2 bg-red-400 rounded-full mr-1"></span>ÊîøÊ≤ª</span>
            <span class="flex items-center"><span class="w-2 h-2 bg-blue-400 rounded-full mr-1"></span>Ëã±ËØ≠</span>
            <span class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-1"></span>ÊâãÁªò</span>
            <span class="flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>ÁêÜËÆ∫</span>
        </div>

        <!-- Calendar Header -->
        <div class="grid grid-cols-7 text-center py-3 bg-white/50 backdrop-blur rounded-t-xl text-xs font-bold text-slate-400 week-header border border-slate-200 border-b-0">
            <div>Âë®‰∏Ä</div><div>Âë®‰∫å</div><div>Âë®‰∏â</div><div>Âë®Âõõ</div><div>Âë®‰∫î</div><div>Âë®ÂÖ≠</div><div>Âë®Êó•</div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid rounded-b-xl overflow-hidden" id="calendar-root">
            <!-- JS will inject days here -->
        </div>

        <div class="mt-8 text-center text-xs text-slate-300 font-mono">
            SYNC ID: <span id="sync-id-display">LOCAL</span>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-800 text-lg">
                    <span id="modal-date"></span> Â≠¶‰π†Êó•ËÆ∞
                </h3>
            </div>
            <div class="p-5">
                <textarea id="note-input" class="w-full h-40 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none resize-none text-sm text-slate-700 leading-relaxed placeholder-slate-400 transition" placeholder="ÂÜô‰∏ã‰ªäÂ§©ÁöÑÂ§çÁõò..."></textarea>
                <div class="mt-4 flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition">ÂèñÊ∂à</button>
                    <button onclick="saveNote()" class="px-5 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-lg font-bold text-sm shadow-lg shadow-slate-200 transition">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // üîß ÈÖçÁΩÆÂå∫ (Âú®ËøôÈáåÂ°´‰∏ÄÊ¨°ÔºåÁªàË∫´Ëá™Âä®ÂêåÊ≠•)
        // ==========================================
        
        // 1. ‰Ω†ÁöÑÂîØ‰∏ÄÂêåÊ≠•ÊöóÂè∑ (ÊØîÂ¶ÇÊâãÊú∫Âè∑ÊàñÊòµÁß∞ÊãºÈü≥)
        const MY_SYNC_ID = "default-user"; 

        // 2. Supabase ÈÖçÁΩÆ (Â°´ÂÖ•‰Ω†ÁöÑ Key)
        const SUPABASE_URL = "https://atpywxgykzhgtzhdpqbe.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cHl3eGd5a3poZ3R6aGRwcWJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTAxNzYsImV4cCI6MjA4MDMyNjE3Nn0.UCd3qH2xpR7BpDFkCHUBkEgHXkj3uG1hUW-qMZ7Ys7s"; 

        // ==========================================

        const calendarData = [
            { day: 1, past: true }, { day: 2, past: true },
            { day: 3, today: true, tasks: [
                { id: "d3_1", text: "ËÇñÂÖ´1-3Â•óÈîôÈ¢ò‰∫åÂà∑", type: "t-pol" },
                { id: "d3_2", text: "ÁêÜËÆ∫: ÂêçËØçËß£Èáä(ÊµÅÊ¥æ)", type: "t-the" },
                { id: "d3_3", text: "Êï¥ÁêÜÂø´È¢ò‰∏áËÉΩÊ®°Êùø", type: "t-art" }
            ]},
            { day: 4, tasks: [
                { id: "d4_1", text: "ËÇñÂÖ´4-6Â•óÈÄâÊã©È¢ò", type: "t-pol" },
                { id: "d4_2", text: "Ëã±ËØ≠ÂÜô‰ΩúÊ®°Êùø(ÂõæË°®)", type: "t-eng" },
                { id: "d4_3", text: "ÁêÜËÆ∫: Â°´Á©∫ÈÄâÊã©Á™ÅÂáª", type: "t-the" }
            ]},
            { day: 5, tasks: [
                { id: "d5_1", text: "ËÇñÂÖ´7-8Â•ó(ÂèØÈÄâ/ÂºÉ)", type: "t-pol" },
                { id: "d5_2", text: "Ëã±ËØ≠ÂÜô‰ΩúÊ®°Êùø(‰π¶‰ø°)", type: "t-eng" },
                { id: "d5_3", text: "Êôö: Â±ÄÈÉ®Á∫øÁ®øx3", type: "t-art" }
            ]},
            { day: 6, tasks: [
                { id: "d6_1", text: "ÊâãÁªò3Â∞èÊó∂Ê®°Êãü", type: "t-art" },
                { id: "d6_2", text: "ËÇñÂÖ´ÂÖ®ÈÉ®ÈîôÈ¢òÂ§çÁõò", type: "t-pol" }
            ]},
            { day: 7, tasks: [
                { id: "d7_1", text: "ÁêÜËÆ∫Ê®°ËÄÉ", type: "t-the" },
                { id: "d7_2", text: "‰∏ãÂçà: Ëã±ËØ≠ÂÖ®ÁúüÊ®°Êãü", type: "t-eng" }
            ]},
            { day: 8, tasks: [
                { id: "d8_1", text: "Ëã±ËØ≠‰ΩúÊñáÊ®°ÊùøÁÜüËÉå", type: "t-eng" },
                { id: "d8_2", text: "ÊâãÁªòÂ§çÁõò/ÊîπÂõæ", type: "t-art" }
            ]},
            { day: 9, tasks: [
                { id: "d9_1", text: "ÁêÜËÆ∫Ê†∏ÂøÉÂêçËØçÁ™ÅÂáª", type: "t-the" },
                { id: "d9_2", text: "È©¨ÂéüÂéüÁêÜÂõûÈ°æ", type: "t-pol" }
            ]},
            { day: 10, note: "ËÇñÂõõÂà∞Ë¥ßÊó•!", specialClass: "bg-xiao-arrival", tasks: [
                { id: "d10_1", text: "ËÇñÂõõÂç∑1+Âç∑2ÈÄâÊã©È¢ò", type: "t-pol" },
                { id: "d10_2", text: "ËÉåËÇñÂõõÂç∑1Â§ßÈ¢ò(Ê≠ªËÉå)", type: "t-pol" }
            ]},
            { day: 11, tasks: [
                { id: "d11_1", text: "ËÇñÂõõÂç∑3+Âç∑4ÈÄâÊã©È¢ò", type: "t-pol" },
                { id: "d11_2", text: "ËÉåËÇñÂõõÂç∑2Â§ßÈ¢ò", type: "t-pol" }
            ]},
            { day: 12, tasks: [
                { id: "d12_1", text: "ËÉåËÇñÂõõÂç∑3Â§ßÈ¢ò", type: "t-pol" },
                { id: "d12_2", text: "Ëøë3Âπ¥ÈòÖËØªÁúüÈ¢òÊâãÊÑü", type: "t-eng" }
            ]},
            { day: 13, tasks: [
                { id: "d13_1", text: "ËÉåËÇñÂõõÂç∑4Â§ßÈ¢ò", type: "t-pol" },
                { id: "d13_2", text: "‰∫åÂà∑ËÇñÂõõÂÖ®ÈÉ®ÈÄâÊã©È¢ò", type: "t-pol" }
            ]},
            { day: 14, tasks: [
                { id: "d14_1", text: "ÊúÄÂêé‰∏ÄÂº†ÂÆåÊï¥Âø´È¢ò", type: "t-art" },
                { id: "d14_2", text: "ÁêÜËÆ∫Êü•ÊºèË°•Áº∫", type: "t-the" }
            ]},
            { day: 15, tasks: [
                { id: "d15_1", text: "ËÇñÂõõÂ§ßÈ¢òÁ¨¨‰∫åËΩÆ", type: "t-pol" },
                { id: "d15_2", text: "ÊâìÂç∞ÂÖ•Âú∫Âá≠ËØÅ", type: "t-pol", style: "border:1px dashed #94a3b8; background:transparent; color:#64748b" }
            ]},
            { day: 16, note: "Âª∫ËÆÆËØ∑ÂÅá", tasks: [
                { id: "d16_1", text: "ÊîøÊ≤ªÈîôÈ¢ò+Êó∂ÊîøÊ≠ªËßí", type: "t-pol" },
                { id: "d16_2", text: "ÁêÜËÆ∫Ê≠ªËßíÊâ´Èô§", type: "t-the" }
            ]},
            { day: 17, note: "Âª∫ËÆÆËØ∑ÂÅá", tasks: [
                { id: "d17_1", text: "‰ΩúÊñáÈªòÂÜôÊúÄÂêé‰∏ÄÈÅç", type: "t-eng" },
                { id: "d17_2", text: "Áúã‰ºòÁßÄÊ°à‰æã(‰∏çÂä®Á¨î)", type: "t-art" }
            ]},
            { day: 18, note: "Âª∫ËÆÆËØ∑ÂÅá", tasks: [
                { id: "d18_1", text: "ËÇñÂõõÊªöÁìúÁÉÇÁÜü", type: "t-pol" },
                { id: "d18_2", text: "ÂÖ®ÊµÅÁ®ãËÑë‰∏äÊºîÁªÉ", type: "t-art" }
            ]},
            { day: 19, tasks: [
                { id: "d19_1", text: "Ë∏©ÁÇπ / ÈÖíÂ∫óÁ°ÆËÆ§", type: "t-pol", style: "border:1px dashed #94a3b8; background:transparent; color:#64748b" },
                { id: "d19_2", text: "22:00 ‰ºëÊÅØ", type: "t-pol" }
            ]},
            { day: 20, specialClass: "bg-red-50", tasks: [
                { id: "d20_1", text: "‰∏äÂçà: ÊîøÊ≤ª", type: "t-pol" },
                { id: "d20_2", text: "‰∏ãÂçà: Ëã±ËØ≠", type: "t-eng" }
            ]},
            { day: 21, specialClass: "bg-red-50", tasks: [
                { id: "d21_1", text: "‰∏äÂçà: ÁêÜËÆ∫", type: "t-the" },
                { id: "d21_2", text: "‰∏ãÂçà: ÊâãÁªò", type: "t-art" }
            ]}
        ];

        let supabaseClient = null;
        let isCloudMode = false;
        let appState = { completedTasks: [], notes: {} };

        // --- Init ---
        async function init() {
            renderCalendar();
            document.getElementById('sync-id-display').innerText = MY_SYNC_ID;

            if (SUPABASE_URL && SUPABASE_KEY) {
                try {
                    const { createClient } = supabase;
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                    isCloudMode = true;
                    setStatus("online");
                    await loadFromCloud();
                } catch (e) {
                    console.error("Supabase Error", e);
                    loadFromLocal();
                }
            } else {
                loadFromLocal();
            }
        }

        // --- Core Logic ---
        async function saveState() {
            updateProgressUI();
            localStorage.setItem('study_dashboard_v1', JSON.stringify(appState)); // Local Backup

            if (isCloudMode && supabaseClient) {
                try {
                    setStatus("syncing");
                    await supabaseClient.from('study_progress').upsert({ id: MY_SYNC_ID, data: appState });
                    setStatus("online");
                } catch (e) {
                    setStatus("error");
                }
            }
        }

        async function loadFromCloud() {
            try {
                const { data } = await supabaseClient.from('study_progress').select('data').eq('id', MY_SYNC_ID).single();
                if (data && data.data) {
                    appState = data.data;
                    refreshUI();
                } else {
                    loadFromLocal();
                }
            } catch (e) {
                loadFromLocal();
            }
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('study_dashboard_v1');
            if (saved) {
                appState = JSON.parse(saved);
                refreshUI();
            }
        }

        // --- UI ---
        function renderCalendar() {
            const root = document.getElementById('calendar-root');
            root.innerHTML = '';
            calendarData.forEach(d => {
                const cell = document.createElement('div');
                cell.className = `day-cell ${d.past ? 'is-past' : ''} ${d.today ? 'is-today' : ''} ${d.specialClass || ''}`;
                cell.id = `day-${d.day}`;
                
                let dayLabel = d.day;
                if(d.today) dayLabel += " <span class='text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded ml-1'>‰ªäÂ§©</span>";
                if(d.note) dayLabel += ` <span class='text-[10px] text-red-400 font-normal ml-1'>${d.note}</span>`;

                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerHTML = `<span>${dayLabel}</span><i class="fas fa-edit note-btn" onclick="openNoteModal(${d.day})"></i>`;
                cell.appendChild(header);

                if (d.tasks) {
                    d.tasks.forEach(t => {
                        const taskEl = document.createElement('div');
                        taskEl.className = `task-tag ${t.type}`;
                        taskEl.innerText = t.text;
                        taskEl.dataset.id = t.id;
                        if(t.style) taskEl.style = t.style;
                        taskEl.onclick = () => toggleTask(t.id);
                        cell.appendChild(taskEl);
                    });
                }
                root.appendChild(cell);
            });
        }

        function refreshUI() {
            document.querySelectorAll('.task-tag').forEach(el => {
                if (appState.completedTasks.includes(el.dataset.id)) el.classList.add('done');
                else el.classList.remove('done');
            });
            Object.keys(appState.notes).forEach(dayKey => {
                const dayNum = dayKey.replace('day_', '');
                const cell = document.getElementById(`day-${dayNum}`);
                if (cell) {
                    if (appState.notes[dayKey]) cell.classList.add('has-note');
                    else cell.classList.remove('has-note');
                }
            });
            updateProgressUI();
        }

        function setStatus(status) {
            const el = document.getElementById('cloud-status');
            if(status === 'online') el.className = "ml-2 w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]";
            if(status === 'syncing') el.className = "ml-2 w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
            if(status === 'error') el.className = "ml-2 w-2 h-2 rounded-full bg-red-400";
        }

        window.toggleTask = function(id) {
            const idx = appState.completedTasks.indexOf(id);
            if (idx > -1) appState.completedTasks.splice(idx, 1);
            else appState.completedTasks.push(id);
            refreshUI();
            saveState();
        };

        // Note Logic
        let currentNoteDay = null;
        const modal = document.getElementById('note-modal');
        const noteInput = document.getElementById('note-input');

        window.openNoteModal = function(day) {
            currentNoteDay = day;
            document.getElementById('modal-date').innerText = `12Êúà${day}Êó•`;
            noteInput.value = appState.notes[`day_${day}`] || '';
            modal.classList.add('open');
            setTimeout(() => noteInput.focus(), 100);
        };
        window.closeModal = function() { modal.classList.remove('open'); };
        window.saveNote = function() {
            const val = noteInput.value.trim();
            if (val) appState.notes[`day_${currentNoteDay}`] = val;
            else delete appState.notes[`day_${currentNoteDay}`];
            refreshUI();
            saveState();
            closeModal();
        };

        function updateProgressUI() {
            const allTasks = document.querySelectorAll('.task-tag').length;
            const doneTasks = appState.completedTasks.length;
            const pct = allTasks === 0 ? 0 : Math.round((doneTasks / allTasks) * 100);
            document.getElementById('progress-val').innerText = pct + "%";
            document.getElementById('progress-bar').style.width = pct + "%";
        }

        init();
    </script>
</body>
</html>
