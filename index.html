<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å†²åˆºè®¡åˆ’ Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å†²åˆºè®¡åˆ’">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="apple-touch-icon" href="" id="apple-icon">
    <link rel="manifest" href="" id="manifest-link">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f6f8fa; -webkit-tap-highlight-color: transparent; }
        
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* å¯¼èˆªæ  */
        .month-nav {
            display: flex; overflow-x: auto; gap: 8px; padding: 4px 0 12px 0; margin-bottom: 0;
            -webkit-overflow-scrolling: touch; scrollbar-width: none; align-items: center;
        }
        .month-nav::-webkit-scrollbar { display: none; }
        
        /* å¸é¡¶å®¹å™¨ */
        .sticky-header-wrapper {
            position: -webkit-sticky; position: sticky; top: 0; z-index: 30;
            background-color: #f6f8fa; 
            padding-top: 8px; padding-bottom: 4px;
            margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.03); 
        }

        .nav-pill {
            flex: 0 0 auto; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700;
            background: #fff; color: #64748b; border: 1px solid #e2e8f0; transition: all 0.2s; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .nav-pill:active { transform: scale(0.95); }
        .nav-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .nav-pill.year-pill { background: #f1f5f9; border-color: #cbd5e1; color: #475569; }
        .nav-pill.year-pill.active { background: #0f172a; border-color: #0f172a; color: white; box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.3); }
        .nav-separator { width: 1px; height: 20px; background: #cbd5e1; flex: 0 0 auto; margin: 0 2px; opacity: 0.5; }

        /* å¡ç‰‡å®¹å™¨ */
        .calendar-wrapper { display: grid; gap: 12px; grid-template-columns: 1fr; }
        /* ç©ºç™½å ä½æ ¼ (Desktop Only) */
        .empty-slot { visibility: hidden; }
        @media (max-width: 800px) { 
            .empty-slot { display: none; } /* æ‰‹æœºç«¯éšè—ç©ºç™½æ ¼ï¼Œå˜æˆæµå¼åˆ—è¡¨ */
        }
        @media (min-width: 800px) { 
            .calendar-wrapper { grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 8px; } 
        }

        .day-card { background: white; border-radius: 12px; padding: 12px; min-height: 100px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; position: relative; transition: all 0.3s; }
        .is-past { background-color: #f9fafb; opacity: 0.8; }
        .is-past .task-item { opacity: 0.7; }
        .is-today { background: #ffffff; ring: 2px solid #3b82f6; box-shadow: 0 8px 20px -6px rgba(59, 130, 246, 0.25); z-index: 10; transform: scale(1.01); border-color: #3b82f6; scroll-margin-top: 140px; }
        .is-holiday { background: #fff1f2; border-color: #fecdd3; } 
        .holiday-tag { position: absolute; right: 8px; top: 8px; font-size: 10px; font-weight: bold; color: #e11d48; background: #ffe4e6; padding: 2px 6px; border-radius: 4px; }

        /* === ä»»åŠ¡æ¡ç›®æ ·å¼ === */
        .task-item { 
            font-size: 0.9rem; padding: 0; margin-bottom: 8px; border-radius: 10px; position: relative; 
            transition: all 0.2s; font-weight: 500; line-height: 1.5; display: flex; align-items: stretch; overflow: hidden;
            background-color: white; border: 1px solid rgba(0,0,0,0.05); width: 100%; max-width: 100%;
        }
        
        /* å·¦ä¾§ç‚¹å‡»åŒº */
        .task-check-zone {
            width: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
            background-color: rgba(0,0,0,0.02); border-right: 1px solid rgba(0,0,0,0.03);
        }
        .task-checkbox {
            width: 18px; height: 18px; border: 2px solid currentColor; border-radius: 6px; opacity: 0.5; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* å³ä¾§å†…å®¹åŒº */
        .task-content-zone {
            flex: 1; padding: 8px 10px; cursor: pointer; display: flex; align-items: center;
            min-width: 0; overflow-wrap: anywhere; word-break: break-word;
        }

        .task-item.done { background-color: #f8fafc !important; color: #94a3b8 !important; border-color: transparent !important; }
        .task-item.done .task-content-zone { text-decoration: line-through; opacity: 0.8; }
        .task-item.done .task-checkbox { background-color: #94a3b8; border-color: #94a3b8; color: white; }
        .task-item.done .task-checkbox::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 10px; }

        .task-item::before { display: none !important; }

        /* åˆ†ç±»é¢œè‰² */
        .t-pol { color: #be123c; background: #fff1f2; border-color: #fecdd3; }
        .t-eng { color: #1d4ed8; background: #eff6ff; border-color: #bfdbfe; }
        .t-art { color: #86198f; background: #fdf4ff; border-color: #e9d5ff; }
        .t-the { color: #047857; background: #ecfdf5; border-color: #a7f3d0; }
        .t-work { color: #1d4ed8; background: #eff6ff; border-color: #bfdbfe; }
        .t-study { color: #7e22ce; background: #faf5ff; border-color: #e9d5ff; }
        .t-life { color: #047857; background: #f0fdf4; border-color: #bbf7d0; }
        .t-urgent { color: #be123c; background: #fef2f2; border-color: #fecaca; }

        .action-btn { opacity: 0.3; transition: 0.2s; padding: 4px; cursor: pointer; font-size: 14px; }
        .day-card:hover .action-btn { opacity: 1; }
        .has-note .note-trigger { color: #f59e0b; opacity: 1; }
        .action-btn:hover { color: #3b82f6; transform: scale(1.1); }

        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .progress-shimmer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }

        @media (max-width: 768px) {
            .week-header { display: none; }
            .day-card { flex-direction: row; flex-wrap: wrap; align-items: flex-start; padding: 16px; gap: 12px; }
            .day-header-mobile { width: 100%; display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #f3f4f6; padding-bottom: 8px; }
            .task-container { width: 100%; }
            .action-btn { opacity: 0.6; padding: 8px; }
            .delete-btn { opacity: 1; }
        }

        .modal-overlay { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: 0.3s; position: fixed; inset: 0; z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-content { 
            background: white; width: 90%; max-width: 1000px; height: 95vh; 
            border-radius: 16px; transform: scale(0.95) translateY(10px); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; 
        }
        .modal-overlay.open .modal-content { transform: scale(1) translateY(0); }

        /* åº•éƒ¨é¢æ¿ */
        .bottom-sheet-content {
            position: absolute; bottom: 0; left: 0; right: 0; width: 100%; max-width: 100%; border-radius: 24px 24px 0 0;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); height: auto; max-height: 80vh;
            padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom));
        }
        .modal-overlay.open .bottom-sheet-content { transform: translateY(0); }

        .add-task-modal { width: 85%; max-width: 320px; height: auto; border-radius: 16px; padding: 24px; }

        /* æœç´¢å¼¹çª—æ ·å¼ */
        .search-modal { width: 90%; max-width: 600px; height: 70vh; max-height: 600px; padding: 0; border-radius: 20px; }
        .search-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
        .search-input { flex: 1; font-size: 16px; outline: none; color: #334155; }
        .search-results { flex: 1; overflow-y: auto; padding: 10px; }
        .search-item { padding: 12px; border-radius: 12px; cursor: pointer; margin-bottom: 8px; transition: 0.2s; border: 1px solid transparent; }
        .search-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        .search-highlight { background: #fef08a; color: #854d0e; padding: 0 2px; rounded: 2px; }
        .empty-state { text-align: center; color: #94a3b8; padding: 40px; font-size: 14px; }

        /* ID å¼¹çª—ä¸“ç”¨æ ·å¼ */
        .id-modal-content { height: auto !important; min-height: 200px; max-width: 320px !important; }

        @media (max-width: 768px) {
            .modal-overlay.note-mode { align-items: flex-end; padding-bottom: 0; }
            .modal-content.note-mode { width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; margin: 0; transform: translateY(100%); height: 95vh; overscroll-behavior: contain; }
            .modal-overlay.open .modal-content.note-mode { transform: translateY(0); }
            .modal-content.note-mode .modal-header { padding-top: 16px; } 
            .modal-content.note-mode .modal-footer { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
            .search-modal { width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; }
            /* ç§»åŠ¨ç«¯ä¿æŒ ID å¼¹çª—å°å·§ */
            .id-modal-content { width: 85% !important; max-width: 320px !important; height: auto !important; border-radius: 16px !important; transform: scale(0.95) !important; margin: auto !important; }
            .modal-overlay.open .id-modal-content { transform: scale(1) !important; }
        }
        
        .editor-scroller { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; background: white; overscroll-behavior: contain; }
        #note-editor { width: 100%; min-height: 100%; padding: 24px; outline: none; color: #334155; font-size: 16px; overflow-wrap: anywhere; word-break: break-word; white-space: pre-wrap; }
        
        #note-editor[contenteditable="false"] { color: #1e293b; background-color: #fff; }
        #note-editor[contenteditable="true"] { background-color: #f8fafc; }

        #note-editor img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #e2e8f0; transition: opacity 0.3s; cursor: zoom-in; }
        .uploading-img { opacity: 0.5; border: 2px dashed #3b82f6 !important; }

        #note-editor table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
        #note-editor th, #note-editor td { border: 1px solid #cbd5e1; padding: 6px; text-align: left; }
        #note-editor th { background-color: #f1f5f9; font-weight: bold; }
        #note-editor ul { list-style-type: disc; padding-left: 20px; margin: 8px 0; }
        #note-editor ol { list-style-type: decimal; padding-left: 20px; margin: 8px 0; }
        #note-editor blockquote { border-left: 4px solid #3b82f6; padding-left: 12px; color: #64748b; margin: 8px 0; background: #f8fafc; padding-top:4px; padding-bottom:4px;}
        #note-editor input[type="checkbox"] { margin-right: 8px; vertical-align: middle; transform: scale(1.3); cursor: pointer; accent-color: #3b82f6; }
        #note-editor[contenteditable="true"]:empty:before { content: attr(placeholder); color: #94a3b8; pointer-events: none; display: block; }

        .sheet-handle { width: 40px; height: 4px; background: #e2e8f0; border-radius: 10px; margin: 8px auto 0; }
        
        .toolbar-btn { padding: 8px; border-radius: 6px; color: #64748b; transition: 0.2s; font-size: 1.1rem; }
        .toolbar-btn:hover { background-color: #eff6ff; color: #3b82f6; }
        
        .countdown-box { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); min-width: 100px; }
        .countdown-num { font-size: 1.8rem; font-weight: 900; line-height: 1; }
        .countdown-label { font-size: 0.65rem; opacity: 0.9; font-weight: 500; margin-top: 2px; }
        
        #sync-btn { cursor: pointer; transition: 0.2s; }
        #sync-btn:hover { opacity: 0.8; }

        #img-zoom-modal { z-index: 200 !important; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; }
        #zoomed-img { object-fit: contain; max-width: 95%; max-height: 95%; border-radius: 4px; transition: transform 0.2s; }

        /* è¡Œé«˜æ§åˆ¶ */
        #note-editor.lh-tight, #note-editor.lh-tight * { line-height: 1.3 !important; }
        #note-editor.lh-normal, #note-editor.lh-normal * { line-height: 1.75 !important; }
        #note-editor.lh-loose, #note-editor.lh-loose * { line-height: 2.2 !important; }
    </style>
</head>
<body class="safe-area-top safe-area-bottom pb-20 md:pb-10">

    <div class="max-w-8xl mx-auto px-4 pt-6 md:pt-10">
        <div class="bg-white rounded-2xl p-5 md:p-6 mb-4 shadow-sm border border-slate-100 relative overflow-hidden">
            <div class="flex flex-row justify-between items-center relative z-10 gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1.5">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500 tracking-wider">DASHBOARD</span>
                        <div id="cloud-status-badge" class="flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] bg-slate-50 text-slate-400 border border-slate-100 cursor-pointer" onclick="changeSyncID()" title="ç‚¹å‡»ä¿®æ”¹åŒæ­¥ID">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> ç¦»çº¿
                        </div>
                    </div>
                    
                    <!-- æ ‡é¢˜ + æœç´¢ -->
                    <div class="flex items-center gap-3 mb-1">
                        <h1 class="text-2xl md:text-3xl font-black text-slate-800 tracking-tight shrink-0" id="main-title">12æœˆå†²åˆº</h1>
                        <div onclick="toggleSearch()" class="bg-slate-50 border border-slate-200 rounded-full px-5 py-1.5 text-xs text-slate-400 flex items-center gap-2 cursor-pointer hover:bg-slate-100 hover:border-blue-200 transition group shadow-sm active:scale-95">
                            <i class="fas fa-search text-slate-300 group-hover:text-blue-500 transition"></i>
                            <span class="font-bold">æœç´¢</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 max-w-xs mt-3">
                        <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden relative">
                            <div id="progress-fill" class="h-full bg-blue-500 rounded-full transition-all duration-700 relative overflow-hidden" style="width: 0%">
                                <div class="progress-shimmer"></div>
                            </div>
                        </div>
                        <span id="progress-text" class="text-xs font-bold text-blue-600">0%</span>
                        <span class="text-[10px] text-slate-400 ml-1" id="progress-label">è¿›åº¦</span>
                    </div>
                </div>

                <div class="countdown-box">
                    <div class="countdown-num" id="days-left">--</div>
                    <div class="countdown-label" id="days-label">å‰©ä½™å¤©æ•°</div>
                </div>
            </div>
            <div class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-blue-50 to-transparent rounded-bl-full opacity-50 -z-0 pointer-events-none"></div>
        </div>

        <!-- ç»Ÿä¸€çš„å¯¼èˆªæ  (é›†æˆå¹´ä»½ + æœˆä»½) åŠ ä¸Šå¸é¡¶å®¹å™¨ -->
        <div class="sticky-header-wrapper">
            <div class="month-nav" id="unified-nav">
                <!-- JS åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="hidden md:grid grid-cols-7 text-center mb-3 text-xs font-bold text-slate-400 week-header px-2">
                <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div><div>SUN</div>
            </div>
        </div>

        <div class="calendar-wrapper" id="calendar-view"></div>

        <div class="mt-12 text-center pb-8">
             <div id="sync-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-full text-xs text-slate-500 font-bold shadow-sm hover:shadow-md" onclick="changeSyncID()">
                <i class="fas fa-fingerprint text-blue-500"></i> åŒæ­¥ID: <span id="sync-id-label" class="text-slate-800 font-mono">LOCAL</span> <i class="fas fa-pen text-[10px] ml-1 opacity-50"></i>
            </div>
            <p class="text-[10px] text-slate-300 mt-2">ID é€šç”¨ï¼šè‡ªåŠ¨åˆå¹¶ 2025/2026 æ•°æ®</p>
        </div>
    </div>

    <!-- ä»»åŠ¡ç®¡ç†é¢æ¿ (åº•éƒ¨å¼¹å‡º) -->
    <div id="task-manage-modal" class="modal-overlay">
        <div class="modal-content bottom-sheet-content bg-white">
            <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-4"></div>
            <h3 class="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                <i class="fas fa-sliders-h text-blue-500"></i> ç®¡ç†ä»»åŠ¡
            </h3>
            
            <textarea id="edit-task-input" rows="3" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none"></textarea>
            
            <div class="flex gap-3 mb-2">
                <button onclick="saveEditedTask()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-200 hover:bg-blue-700 transition">ä¿å­˜ä¿®æ”¹</button>
            </div>
            <div class="flex gap-3">
                <button onclick="closeTaskManage()" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm hover:bg-slate-200 transition">å–æ¶ˆ</button>
                <button onclick="deleteCurrentTask()" class="flex-1 py-3 bg-red-50 text-red-500 border border-red-100 rounded-xl font-bold text-sm hover:bg-red-100 transition">åˆ é™¤ä»»åŠ¡</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ä»»åŠ¡ Modal -->
    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-content bottom-sheet-content bg-white">
            <h3 class="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                <span class="w-1 h-5 bg-blue-500 rounded-full"></span> æ–°å¢ä»»åŠ¡
            </h3>
            <input type="text" id="new-task-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-5 outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="ä¾‹å¦‚ï¼šèƒŒè¯µè‹±è¯­å•è¯..." onkeydown="if(event.key === 'Enter') confirmAddTask()">
            
            <div class="grid grid-cols-2 gap-3 mb-6" id="type-selector-container">
                <!-- JS åŠ¨æ€ç”Ÿæˆåˆ†ç±» -->
            </div>

            <div class="flex gap-3">
                <button onclick="closeAddTaskModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm hover:bg-slate-200 transition">å–æ¶ˆ</button>
                <button onclick="confirmAddTask()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-200 hover:bg-blue-700 transition">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æœç´¢ Modal -->
    <div id="search-modal" class="modal-overlay">
        <div class="modal-content search-modal bg-white flex flex-col">
            <div class="search-header">
                <i class="fas fa-search text-slate-400"></i>
                <input type="text" id="search-input" class="search-input" placeholder="æœç´¢ç¬”è®°æˆ–ä»»åŠ¡..." oninput="handleSearch(this.value)">
                <button onclick="toggleSearch()" class="text-slate-400 hover:text-slate-600 text-sm font-bold">å–æ¶ˆ</button>
            </div>
            <div id="search-results" class="search-results">
                <div class="empty-state">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢...</div>
            </div>
        </div>
    </div>

    <!-- ID è®¾ç½® Modal -->
    <div id="id-modal" class="modal-overlay">
        <div class="modal-content id-modal-content bg-white flex flex-col justify-center p-6">
            <h3 class="font-bold text-lg mb-4 text-slate-800">è®¾ç½®åŒæ­¥ ID</h3>
            <p class="text-xs text-slate-400 mb-4">è®¾ç½®ç›¸åŒçš„ ID (å¦‚ "payen") å³å¯åœ¨æ‰‹æœºå’Œç”µè„‘é—´åŒæ­¥æ‰€æœ‰æ•°æ®ã€‚</p>
            <input type="text" id="sync-id-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-5 outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono text-center tracking-wider" placeholder="è¾“å…¥ ID..." onkeydown="if(event.key === 'Enter') saveSyncID()">
            <div class="flex gap-3">
                <button onclick="closeIdModal()" class="flex-1 py-2 bg-slate-100 text-slate-500 rounded-lg font-bold text-sm hover:bg-slate-200 transition">å–æ¶ˆ</button>
                <button onclick="saveSyncID()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-blue-700 transition">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§ Modal -->
    <div id="img-zoom-modal" class="modal-overlay" onclick="this.classList.remove('open')">
        <img id="zoomed-img" src="" onclick="event.stopPropagation()">
    </div>

    <!-- ç¬”è®° Modal -->
    <div id="note-modal" class="modal-overlay note-mode">
        <div class="modal-content note-mode">
            <div class="md:hidden w-full bg-white pt-2 pb-1 shrink-0" onclick="closeModal()">
                <div class="sheet-handle"></div>
            </div>

            <div class="modal-header bg-white px-5 py-3 border-b border-slate-100 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
                    <h3 class="font-bold text-slate-800 text-lg">ğŸ“ <span id="modal-date-title"></span></h3>
                    <span id="mode-badge" class="text-[10px] px-2 py-0.5 rounded bg-slate-100 text-slate-500 font-medium">æŸ¥çœ‹æ¨¡å¼</span>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center transition text-xl">&times;</button>
            </div>
            
            <div class="editor-scroller">
                <div id="note-editor" contenteditable="false" class="lh-normal" placeholder="ç‚¹å‡»ä¸‹æ–¹â€œç¼–è¾‘â€å¼€å§‹è®°å½•..."></div>
            </div>
            
            <div class="modal-footer bg-white px-4 py-3 border-t border-slate-100 flex justify-between items-center shrink-0 safe-area-bottom">
                <div id="editor-tools" class="flex gap-1 opacity-0 pointer-events-none transition-opacity duration-200 items-center">
                    <button class="toolbar-btn" onclick="execCmd('bold')" title="åŠ ç²—"><i class="fas fa-bold"></i></button>
                    <button class="toolbar-btn" onclick="execCmd('backColor', '#fef08a')" title="é«˜äº®"><i class="fas fa-highlighter text-yellow-500"></i></button>
                    <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="åˆ—è¡¨"><i class="fas fa-list-ul"></i></button>
                    <button class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="æ•°å­—åˆ—è¡¨"><i class="fas fa-list-ol"></i></button>
                    <button class="toolbar-btn" onclick="insertCheckbox()" title="ä»»åŠ¡æ¡†"><i class="far fa-check-square"></i></button>
                    <button class="toolbar-btn" onclick="cycleLineHeight()" title="è°ƒæ•´è¡Œè·"><i class="fas fa-text-height"></i></button>
                </div>

                <div class="flex gap-3">
                    <button id="edit-btn" onclick="toggleEditMode()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-5 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                        <i class="fas fa-pen"></i> ç¼–è¾‘
                    </button>
                    <button id="save-btn" onclick="saveNote()" class="hidden bg-slate-900 hover:bg-black text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-slate-200 transition flex items-center gap-2">
                        <i class="fas fa-check"></i> å®Œæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const DEFAULT_SYNC_ID = "payen"; 
        const SUPABASE_URL = "https://atpywxgykzhgtzhdpqbe.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cHl3eGd5a3poZ3R6aGRwcWJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTAxNzYsImV4cCI6MjA4MDMyNjE3Nn0.UCd3qH2xpR7BpDFkCHUBkEgHXkj3uG1hUW-qMZ7Ys7s";
        
        // 2026 èŠ‚å‡æ—¥ (è¡¥å……å®Œæ•´ç‰ˆ)
        const HOLIDAYS_2026 = {
            "1-1": "å…ƒæ—¦", "1-2": "å‡æœŸ", "1-3": "å‡æœŸ",
            "2-15": "å‡æœŸ", "2-16": "é™¤å¤•", "2-17": "æ˜¥èŠ‚", "2-18": "åˆäºŒ", "2-19": "åˆä¸‰", "2-20": "åˆå››", "2-21": "åˆäº”", "2-22": "åˆå…­", "2-23": "åˆä¸ƒ",
            "4-5": "æ¸…æ˜",
            "5-1": "åŠ³åŠ¨èŠ‚", "5-2": "å‡æœŸ", "5-3": "å‡æœŸ", "5-4": "å‡æœŸ", "5-5": "å‡æœŸ",
            "6-19": "ç«¯åˆ", "6-20": "å‡æœŸ", "6-21": "å‡æœŸ",
            "9-25": "ä¸­ç§‹", "9-26": "å‡æœŸ", "9-27": "å‡æœŸ",
            "10-1": "å›½åº†", "10-2": "å‡æœŸ", "10-3": "å‡æœŸ", "10-4": "å‡æœŸ", "10-5": "å‡æœŸ", "10-6": "å‡æœŸ", "10-7": "å‡æœŸ"
        };
        
        // 2025 é™æ€æ•°æ® (User Provided)
        const CALENDAR_DATA_2025 = [
            { day: 1 }, { day: 2 }, 
            { day: 3, tasks: [{ id: "t3_1", text: "è‚–å…«1-3å¥—é”™é¢˜äºŒåˆ·", type: "t-pol" }, { id: "t3_2", text: "å·¥ä¸šè®¾è®¡å²: åè¯è§£é‡Š(æµæ´¾)", type: "t-the" }, { id: "t3_3", text: "æ•´ç†å¿«é¢˜ä¸‡èƒ½æ¨¡æ¿", type: "t-art" }]},
            { day: 4, tasks: [{ id: "t4_1", text: "è‚–å…«4-6å¥—é€‰æ‹©é¢˜", type: "t-pol" }, { id: "t4_2", text: "è‹±è¯­å†™ä½œæ¨¡æ¿(å›¾è¡¨)", type: "t-eng" }, { id: "t4_3", text: "å·¥ä¸šè®¾è®¡å²: å¡«ç©ºé€‰æ‹©çªå‡»", type: "t-the" }]},
            { day: 5, tasks: [{ id: "t5_1", text: "è‚–å…«7-8å¥—(å¯é€‰)", type: "t-pol" }, { id: "t5_2", text: "è‹±è¯­å†™ä½œæ¨¡æ¿(ä¹¦ä¿¡)", type: "t-eng" }, { id: "t5_3", text: "æ™š: å±€éƒ¨çº¿ç¨¿x3", type: "t-art" }]},
            { day: 6, tasks: [{ id: "t6_1", text: "æ‰‹ç»˜3å°æ—¶æ¨¡æ‹Ÿ", type: "t-art" }, { id: "t6_2", text: "è‚–å…«å…¨éƒ¨é”™é¢˜å¤ç›˜", type: "t-pol" }]},
            { day: 7, tasks: [{ id: "t7_1", text: "å·¥ä¸šè®¾è®¡å²æ¨¡è€ƒ", type: "t-the" }, { id: "t7_2", text: "ä¸‹åˆ: è‹±è¯­å…¨çœŸæ¨¡æ‹Ÿ", type: "t-eng" }]},
            { day: 8, tasks: [{ id: "t8_1", text: "è‹±è¯­ä½œæ–‡æ¨¡æ¿ç†ŸèƒŒ", type: "t-eng" }, { id: "t8_2", text: "æ‰‹ç»˜å¤ç›˜/æ”¹å›¾", type: "t-art" }]},
            { day: 9, tasks: [{ id: "t9_1", text: "å·¥ä¸šè®¾è®¡å²æ ¸å¿ƒåè¯çªå‡»", type: "t-the" }, { id: "t9_2", text: "é©¬åŸåŸç†å›é¡¾", type: "t-pol" }]},
            { day: 10, note: "è‚–å››åˆ°è´§!", special: true, tasks: [{ id: "t10_1", text: "è‚–å››å·1+å·2é€‰æ‹©é¢˜", type: "t-pol" }, { id: "t10_2", text: "èƒŒè‚–å››å·1å¤§é¢˜(æ­»èƒŒ)", type: "t-pol" }]},
            { day: 11, tasks: [{ id: "t11_1", text: "è‚–å››å·3+å·4é€‰æ‹©é¢˜", type: "t-pol" }, { id: "t11_2", text: "èƒŒè‚–å››å·2å¤§é¢˜", type: "t-pol" }]},
            { day: 12, tasks: [{ id: "t12_1", text: "èƒŒè‚–å››å·3å¤§é¢˜", type: "t-pol" }, { id: "t12_2", text: "è¿‘3å¹´é˜…è¯»çœŸé¢˜æ‰‹æ„Ÿ", type: "t-eng" }]},
            { day: 13, tasks: [{ id: "t13_1", text: "èƒŒè‚–å››å·4å¤§é¢˜", type: "t-pol" }, { id: "t13_2", text: "äºŒåˆ·è‚–å››å…¨éƒ¨é€‰æ‹©é¢˜", type: "t-pol" }]},
            { day: 14, tasks: [{ id: "t14_1", text: "æœ€åä¸€å¼ å®Œæ•´å¿«é¢˜", type: "t-art" }, { id: "t14_2", text: "å·¥ä¸šè®¾è®¡å²æŸ¥æ¼è¡¥ç¼º", type: "t-the" }]},
            { day: 15, tasks: [{ id: "t15_1", text: "è‚–å››å¤§é¢˜ç¬¬äºŒè½®", type: "t-pol" }, { id: "t15_2", text: "æ‰“å°å…¥åœºå‡­è¯", type: "t-pol" }]},
            { day: 16, note: "å»ºè®®è¯·å‡", tasks: [{ id: "t16_1", text: "æ”¿æ²»é”™é¢˜+æ—¶æ”¿æ­»è§’", type: "t-pol" }, { id: "t16_2", text: "å·¥ä¸šè®¾è®¡å²æ­»è§’æ‰«é™¤", type: "t-the" }]},
            { day: 17, note: "å»ºè®®è¯·å‡", tasks: [{ id: "t17_1", text: "ä½œæ–‡é»˜å†™æœ€åä¸€é", type: "t-eng" }, { id: "t17_2", text: "çœ‹ä¼˜ç§€æ¡ˆä¾‹", type: "t-art" }]},
            { day: 18, note: "å»ºè®®è¯·å‡", tasks: [{ id: "t18_1", text: "è‚–å››æ»šç“œçƒ‚ç†Ÿ", type: "t-pol" }, { id: "t18_2", text: "å…¨æµç¨‹è„‘ä¸Šæ¼”ç»ƒ", type: "t-art" }]},
            { day: 19, tasks: [{ id: "t19_1", text: "è¸©ç‚¹ / é…’åº—ç¡®è®¤", type: "t-pol" }, { id: "t19_2", text: "22:00 ä¼‘æ¯", type: "t-pol" }]},
            { day: 20, note: "Day 1", special: true, tasks: [{ id: "t20_1", text: "ä¸Šåˆ: æ”¿æ²»", type: "t-pol" }, { id: "t20_2", text: "ä¸‹åˆ: è‹±è¯­", type: "t-eng" }]},
            { day: 21, note: "Day 2", special: true, tasks: [{ id: "t21_1", text: "ä¸Šåˆ: å·¥ä¸šè®¾è®¡å²", type: "t-the" }, { id: "t21_2", text: "ä¸‹åˆ: æ‰‹ç»˜", type: "t-art" }]}
        ];

        // 2026 é¢„è®¾å­¦ä¹ è®¡åˆ’ (è‡ªåŠ¨æ³¨å…¥)
        const PLAN_2026_INIT = {
            "2026-1-22": [
                {id:"p1", text:"åŠ è¯•è‹±è¯­ï¼šèƒŒè¯µ20ä¸ª Material Design åè¯", type:"t-study"},
                {id:"p2", text:"æ„æˆï¼šæ‰‹ç»˜å¤å¥(å¹³è¡Œçº¿/åŒå¿ƒåœ†)", type:"t-work"},
                {id:"p3", text:"ä½œå“é›†ï¼šæ•´ç† Escape_App PRD", type:"t-work"}
            ],
            "2026-1-23": [
                {id:"p4", text:"åŠ è¯•è‹±è¯­ï¼šç¿»è¯‘ Apple HIG æ‰‹åŠ¿æè¿°", type:"t-study"},
                {id:"p5", text:"å¤è¯•å¿«é¢˜ï¼šä¸´æ‘¹3ä¸ªæ™ºèƒ½ç¡¬ä»¶çº¿ç¨¿", type:"t-work"}
            ],
            "2026-1-24": [
                {id:"p6", text:"ä¸Šåˆï¼šæ¨¡æ‹Ÿæ„æˆåŸºç¡€(é»‘ç™½-ç§©åºä¸æ··æ²Œ)", type:"t-work"},
                {id:"p7", text:"ä¸‹åˆï¼šBaichuan Bç«¯ç•Œé¢é‡ç»˜", type:"t-work"},
                {id:"p8", text:"æ™šä¸Šï¼šå¤ç›˜ç”»ä½œ", type:"t-study"}
            ],
            "2026-1-25": [
                {id:"p9", text:"ä¸Šåˆï¼šæ¨¡æ‹Ÿäº§å“å¿«é¢˜(è€å¹´äººè¾…åŠ©)", type:"t-work"},
                {id:"p10", text:"ä¸‹åˆï¼šEscape_App User Flow (è‹±æ–‡æ ‡æ³¨)", type:"t-work"},
                {id:"p11", text:"æ™šä¸Šï¼šæ•´ç†ä¸‹å‘¨è®¡åˆ’", type:"t-life"}
            ],
            "2026-1-26": [
                {id:"p12", text:"è‹±è¯­ï¼šç§¯ç´¯ UX å¿ƒç†å­¦è¯æ±‡", type:"t-study"},
                {id:"p13", text:"æ„æˆï¼šç”»12è‰²ç›¸ç¯", type:"t-work"}
            ],
            "2026-1-27": [
                {id:"p14", text:"è‹±è¯­ï¼šBaichuan é¡¹ç›®èƒŒæ™¯è‹±æ–‡ä»‹ç»", type:"t-study"},
                {id:"p15", text:"ä½œå“é›†ï¼šä¼˜åŒ–ä¿¡æ¯æ¶æ„å›¾", type:"t-work"}
            ],
            "2026-1-28": [
                {id:"p16", text:"æ„æˆï¼šå‘½é¢˜ç»ƒä¹ â€œé€Ÿåº¦æ„Ÿâ€", type:"t-work"},
                {id:"p17", text:"ä½œå“é›†ï¼šEscape_App ç—›ç‚¹åˆ†ææ’ç‰ˆ", type:"t-work"}
            ],
            "2026-1-29": [
                {id:"p18", text:"è‹±è¯­ï¼šé˜…è¯» AI + Design çŸ­æ–‡", type:"t-study"},
                {id:"p19", text:"å¿«é¢˜ï¼šç»ƒä¹ ç”»çˆ†ç‚¸å›¾", type:"t-work"}
            ],
            "2026-1-30": [
                {id:"p20", text:"å¤ç›˜ï¼šæ•´ç†é”™é¢˜/ç”Ÿè¯", type:"t-study"},
                {id:"p21", text:"ä½œå“é›†ï¼šæ”¶å°¾æœªå®Œæˆé¡µé¢", type:"t-work"}
            ],
            "2026-1-31": [
                {id:"p22", text:"ä¸Šåˆï¼šæ¨¡æ‹Ÿæ„æˆåŸºç¡€(è‰²å½©-æ˜¥å¤ç§‹å†¬)", type:"t-work"},
                {id:"p23", text:"ä¸‹åˆï¼šä½œå“é›†å®šç¨¿å†²åˆº", type:"t-work"}
            ],
            "2026-2-1": [
                {id:"p24", text:"ä¸Šåˆï¼šæ¨¡æ‹Ÿä¸“ä¸šè‹±è¯­(è®ºæ–‡äº’è¯‘)", type:"t-study"},
                {id:"p25", text:"ä¸‹åˆï¼šä½œå“é›†æ’ç‰ˆ(InDesign/Figma)", type:"t-work"}
            ],
            "2026-2-3": [{id:"p26", text:"ä½œå“é›†å¯¼å‡º PDFï¼Œæ£€æŸ¥é”™åˆ«å­—", type:"t-work"}],
            "2026-2-5": [{id:"p27", text:"å‡†å¤‡é¢è¯•å¸¸é—®é—®é¢˜(è‹±æ–‡)", type:"t-study"}],
            "2026-2-7": [
                {id:"p28", text:"å…¨çœŸæ¨¡æ‹Ÿï¼šä¸Šåˆç”»å¿«é¢˜", type:"t-urgent"},
                {id:"p29", text:"å…¨çœŸæ¨¡æ‹Ÿï¼šä¸‹åˆè‹±è¯­é˜…è¯»", type:"t-urgent"},
                {id:"p30", text:"å…¨çœŸæ¨¡æ‹Ÿï¼šæ™šä¸ŠèƒŒå£è¯­", type:"t-urgent"}
            ],
            "2026-2-8": [{id:"p31", text:"æ•´ç†ï¼šæŸ¥æ¼è¡¥ç¼º/æ‰“å°å‡†è€ƒè¯/å·¥å…·åŒ…", type:"t-life"}],
            "2026-2-9": [{id:"p32", text:"æµè§ˆå¹¿å·¥å¯¼å¸ˆç ”ç©¶æ–¹å‘", type:"t-study"}],
            "2026-2-10": [{id:"p33", text:"çœ‹1-2ç¯‡ç›¸å…³è®ºæ–‡(é¢è¯•è°ˆèµ„)", type:"t-study"}],
            "2026-2-12": [{id:"p34", text:"å¬è®¾è®¡ç±»æ’­å®¢ (Design Matters)", type:"t-study"}],
            "2026-2-17": [{id:"p35", text:"åˆ©ç”¨å·¥ä½œé—´éš™çœ‹è‹±æ–‡è®¾è®¡æ–‡ç« ", type:"t-study"}],
            "2026-2-21": [{id:"p36", text:"æ‰‹ç»˜ï¼šç”»ä¸€å¼ å®Œæ•´æ„æˆ/äº§å“å¿«é¢˜", type:"t-work"}],
            "2026-2-23": [{id:"p37", text:"å¿ƒæ€å»ºè®¾ï¼šå‡†å¤‡æŸ¥åˆ†è¯ä»¶å·", type:"t-life"}],
            "2026-2-24": [{id:"p38", text:"ğŸ¯ å‡ºåˆ†æ—¥/å†³æ–­æ—¥", type:"t-urgent"}]
        };

        // è‡ªåŠ¨å¡«å…… 2.2 - 2.6 çš„æ¯æ—¥é‡å¤ä»»åŠ¡
        for(let d=2; d<=6; d++) {
            const k = `2026-2-${d}`;
            if(!PLAN_2026_INIT[k]) PLAN_2026_INIT[k] = [];
            PLAN_2026_INIT[k].unshift(
                {id:`rep1_${d}`, text:"æ¯æ—¥å£è¯­ï¼šèƒŒè¯µè‡ªæˆ‘ä»‹ç»(20min)", type:"t-study"},
                {id:`rep2_${d}`, text:"æ‰‹ç»˜ä¿é²œï¼šç¡å‰å°ç¨¿(30min)", type:"t-work"}
            );
        }

        /* PWA Config */
        const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="background:#3b82f6"><rect width="512" height="512" fill="#3b82f6"/><path d="M368 128h-32V96h-64v32H240V96h-64v32h-32c-17.6 0-32 14.4-32 32v256c0 17.6 14.4 32 32 32h224c17.6 0 32-14.4 32-32V160c0-17.6-14.4-32-32-32zm0 288H144V208h224v208z" fill="white"/><path d="M192 336l48 48 96-96" fill="none" stroke="#10b981" stroke-width="30" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        const iconUrl = URL.createObjectURL(new Blob([iconSVG], {type: 'image/svg+xml'}));
        document.getElementById('apple-icon').href = iconUrl;
        
        const manifest = { name: "å†²åˆºè®¡åˆ’ Pro", short_name: "å†²åˆº", start_url: window.location.href, display: "standalone", background_color: "#f6f8fa", theme_color: "#ffffff", icons: [{ src: iconUrl, sizes: "512x512", type: "image/svg+xml" }] };
        document.getElementById('manifest-link').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));

        // ================= å…¨å±€çŠ¶æ€ =================
        let CURRENT_YEAR = 2025; // é»˜è®¤ä¸º2025æ¨¡å¼
        let currentMonth2026 = new Date().getMonth();
        let supabaseClient = null, isCloud = false;
        
        // ç»Ÿä¸€çš„å¤§çŠ¶æ€å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¹´ä»½
        // ç»“æ„: { "2025": { done:[], notes:{}, ...}, "2026": { done:[], ...} }
        let fullState = { 
            "2025": { done: [], notes: {}, customTasks: {} }, 
            "2026": { done: [], notes: {}, customTasks: {} } 
        };
        
        // æŒ‡å‘å½“å‰å¹´ä»½æ•°æ®çš„å¼•ç”¨ï¼Œç®€åŒ–ä»£ç 
        let currentState = fullState["2025"]; 
        
        let MY_SYNC_ID = localStorage.getItem('study_sync_id') || DEFAULT_SYNC_ID;
        let lineHeightIdx = parseInt(localStorage.getItem('study_lh_idx')) || 1; 
        const lhClasses = ['lh-tight', 'lh-normal', 'lh-loose'];

        // ================= åˆå§‹åŒ– =================
        async function init() {
            const now = new Date();
            // é»˜è®¤åˆ¤æ–­ï¼šå¦‚æœæ˜¯ 2026 å¹´ï¼Œæˆ–è€…å·²ç»æ˜¯ 2025 å¹´åº•ä½†ä¸æ˜¯ demo æ¨¡å¼
            if (now.getFullYear() === 2026) {
                CURRENT_YEAR = 2026;
                currentMonth2026 = now.getMonth();
            } else if (now.getFullYear() === 2025 && now.getMonth() === 11) {
                // å¦‚æœæ˜¯ 2025 å¹´ 12 æœˆ
                CURRENT_YEAR = 2025;
            } else {
                // å›é€€åˆ°ä¸Šæ¬¡ä¿å­˜çš„å¹´ä»½ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ 2025
                const lastYear = parseInt(localStorage.getItem('study_last_year'));
                if(lastYear) CURRENT_YEAR = lastYear;
            }

            updateSyncLabel();
            applyLineHeight();
            initEditorEvents();

            if(SUPABASE_URL && SUPABASE_KEY) {
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    isCloud = true; updateStatus('online'); await loadCloud();
                } catch(e) { console.error(e); loadLocal(); }
            } else loadLocal();
            
            // Render initial UI based on loaded year
            switchYear(CURRENT_YEAR);

            // ç‚¹å‡»é®ç½©å…³é—­ (Click outside to close)
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => {
                    if (e.target === overlay) {
                        const id = overlay.id;
                        if (id === 'note-modal') closeModal();
                        else if (id === 'add-task-modal') closeAddTaskModal();
                        else if (id === 'task-manage-modal') closeTaskManage();
                        else if (id === 'search-modal') toggleSearch();
                        else if (id === 'id-modal') closeIdModal();
                        else overlay.classList.remove('open');
                    }
                });
            });
            
            // å»¶æ—¶æ»šåŠ¨åˆ°â€œä»Šå¤©â€
            setTimeout(() => {
                const todayEl = document.querySelector('.is-today');
                if (todayEl) {
                    todayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 800); // ç¨å¾®å»¶æ—¶ç­‰å¾…æ¸²æŸ“å®Œæˆ
        }

        // ================= æ ¸å¿ƒé€»è¾‘ï¼šå¹´ä»½åˆ‡æ¢ =================
        window.switchYear = (year) => {
            CURRENT_YEAR = year;
            localStorage.setItem('study_last_year', year);
            
            // åˆ‡æ¢çŠ¶æ€å¼•ç”¨
            currentState = fullState[year.toString()];
            
            // æ¸²æŸ“å¯¼èˆªæ  (åŒ…å«å¹´ä»½åˆ‡æ¢æŒ‰é’®)
            renderNav();

            if (year === 2025) {
                document.getElementById('main-title').innerText = "12æœˆå†²åˆº";
                document.getElementById('days-label').innerText = "è·ç¦»è€ƒè¯•ä»…å‰©";
                render2025();
                updateCountdown2025();
            } else {
                document.getElementById('main-title').innerText = `2026å¹´ ${currentMonth2026 + 1}æœˆ`;
                document.getElementById('days-label').innerText = "ä»Šå¹´å‰©ä½™å¤©æ•°";
                render2026(currentMonth2026);
                updateCountdown2026();
            }
            refresh(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
        }

        // ================= æ¸²æŸ“ï¼šç»Ÿä¸€å¯¼èˆªæ  (é›†æˆå¹´ä»½åˆ‡æ¢) =================
        function renderNav() {
            const nav = document.getElementById('unified-nav');
            let html = '';

            // 1. å¹´ä»½åˆ‡æ¢èƒ¶å›Š
            html += `
                <div class="nav-pill year-pill ${CURRENT_YEAR === 2025 ? 'active' : ''}" onclick="switchYear(2025)">
                    2025
                </div>
                <div class="nav-pill year-pill ${CURRENT_YEAR === 2026 ? 'active' : ''}" onclick="switchYear(2026)">
                    2026
                </div>
                <div class="nav-separator"></div>
            `;

            // 2. æœˆä»½åˆ—è¡¨ (ä»…2026æ˜¾ç¤º)
            if (CURRENT_YEAR === 2026) {
                const months = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
                html += months.map((m, i) => 
                    `<div class="nav-pill ${i === currentMonth2026 ? 'active' : ''}" onclick="currentMonth2026=${i};switchYear(2026)">${m}</div>`
                ).join('');
            } else {
                html += `<div class="nav-pill active" style="opacity:0.5; pointer-events:none;">å†²åˆºæœˆ</div>`;
            }

            nav.innerHTML = html;
        }

        // ================= æ¸²æŸ“ï¼š2025 å†²åˆº =================
        function render2025() {
            const root = document.getElementById('calendar-view'); root.innerHTML = '';
            
            // è¡¥å…¨åˆ°31å¤©
            for (let i = 1; i <= 31; i++) {
                // æŸ¥æ‰¾é™æ€æ•°æ®
                let d = CALENDAR_DATA_2025.find(item => item.day === i);
                
                // é»˜è®¤æ„é€ 
                const isPast = d ? (d.day < 4) : (i < 4); // Demo day
                const isToday = d ? (d.day === 4) : (i === 4);
                
                const card = document.createElement('div');
                card.className = `day-card ${isPast?'is-past':''} ${isToday?'is-today':''}`;
                if(d && d.special) card.style.background = "repeating-linear-gradient(45deg, #fff, #fff 10px, #fdf2f8 10px, #fdf2f8 20px)";
                card.id = `day-${i}`;
                
                const key = `d${i}`; // 2025ä½¿ç”¨ç®€å•çš„ d1, d2 key
                
                // Header
                const header = document.createElement('div');
                header.className = 'day-header-mobile md:w-full md:border-b-0 md:mb-2 md:pb-0 flex justify-between items-center';
                let label = `<span class="text-xl font-bold text-slate-700 font-mono">${i}</span>` + 
                            (isToday ? `<span class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">ä»Šå¤©</span>` : '') + 
                            (d && d.note ? `<span class="ml-2 text-[10px] text-red-400 font-medium">${d.note}</span>`:'');
                
                const hasNote = currentState.notes[key] ? 'has-note' : '';
                
                header.innerHTML = `<div>${label}</div> 
                    <div class="flex gap-2 ${hasNote}">
                        <i class="fas fa-plus action-btn text-slate-400" onclick="openAddTaskModal('${key}')"></i>
                        <i class="fas fa-edit action-btn text-slate-400 note-trigger" onclick="openNote('${key}')" id="icon-${key}"></i>
                    </div>`;
                card.appendChild(header);

                // Tasks
                const con = document.createElement('div'); con.className = 'task-container w-full';
                if(d && d.tasks) d.tasks.forEach(t => con.appendChild(createEl(t, false, key)));
                const custom = currentState.customTasks[key] || [];
                custom.forEach(t => con.appendChild(createEl(t, true, key)));
                
                card.appendChild(con); root.appendChild(card);
            }
        }

        // ================= æ¸²æŸ“ï¼š2026 å…¨å¹´ =================
        function render2026(monthIdx) {
            const root = document.getElementById('calendar-view'); root.innerHTML = '';
            // Update title dynamically when rendering
            document.getElementById('main-title').innerText = `2026å¹´ ${monthIdx + 1}æœˆ`;
            
            const firstDay = new Date(2026, monthIdx, 1);
            const daysInMonth = new Date(2026, monthIdx + 1, 0).getDate();
            const today = new Date();
            const isCurrMonth = today.getFullYear() === 2026 && today.getMonth() === monthIdx;

            // è®¡ç®—è¯¥æœˆç¬¬ä¸€å¤©æ˜¯å‘¨å‡  (0=Sun, 1=Mon...6=Sat)
            const startOffset = (firstDay.getDay() + 6) % 7;

            // å¡«å……ç©ºç™½æ ¼
            for(let j=0; j<startOffset; j++) {
                const empty = document.createElement('div');
                empty.className = 'empty-slot';
                root.appendChild(empty);
            }

            for(let i=1; i<=daysInMonth; i++) {
                const dateKey = `2026-${monthIdx+1}-${i}`;
                const holiday = HOLIDAYS_2026[`${monthIdx+1}-${i}`];
                
                const isPast = isCurrMonth ? (i < today.getDate()) : (new Date() > new Date(2026, monthIdx, i));
                const isToday = isCurrMonth && i === today.getDate();

                const card = document.createElement('div');
                card.className = `day-card ${isPast?'is-past':''} ${isToday?'is-today':''} ${holiday?'is-holiday':''}`;
                if (isToday) card.classList.add('is-today'); 

                const label = `<span class="text-xl font-bold text-slate-700 font-mono">${i}</span>` + 
                              (isToday ? `<span class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">ä»Šå¤©</span>` : '') +
                              (holiday ? `<span class="holiday-tag">${holiday}</span>` : '');
                
                const hasNote = currentState.notes[dateKey] ? 'has-note' : '';
                
                const header = document.createElement('div');
                header.className = 'day-header-mobile md:w-full md:border-b-0 md:mb-2 md:pb-0 flex justify-between items-center';
                header.innerHTML = `<div>${label}</div> 
                    <div class="flex gap-2 ${hasNote}">
                        <i class="fas fa-plus action-btn text-slate-400" onclick="openAddTaskModal('${dateKey}')"></i>
                        <i class="fas fa-edit action-btn text-slate-400 note-trigger" onclick="openNote('${dateKey}')" id="icon-${dateKey}"></i>
                    </div>`;
                card.appendChild(header);

                const con = document.createElement('div'); con.className = 'task-container w-full';
                const tasks = currentState.customTasks[dateKey] || [];
                tasks.forEach(t => con.appendChild(createEl(t, true, dateKey)));
                
                card.appendChild(con); root.appendChild(card);
            }
        }

        // ================= æ ¸å¿ƒä¿®æ”¹ï¼šå·¦å‹¾é€‰ï¼Œå³è¯¦æƒ… =================
        function createEl(t, isCustom, key) {
            const el = document.createElement('div');
            el.className = `task-item ${t.type}`;
            el.dataset.id = t.id;
            
            // å·¦ä¾§æ‰“å‹¾åŒº
            const checkZone = document.createElement('div');
            checkZone.className = 'task-check-zone';
            checkZone.innerHTML = `<div class="task-checkbox"></div>`;
            checkZone.onclick = (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œåªè§¦å‘æ‰“å‹¾
                toggle(t.id);
            };
            
            // å³ä¾§å†…å®¹åŒº
            const contentZone = document.createElement('div');
            contentZone.className = 'task-content-zone';
            contentZone.innerText = t.text;
            contentZone.onclick = (e) => {
                if(!isCustom) return; // åªæœ‰è‡ªå®šä¹‰ä»»åŠ¡å¯ç¼–è¾‘
                openTaskManage(key, t.id, t.text);
            };
            
            el.appendChild(checkZone);
            el.appendChild(contentZone);
            return el;
        }

        // ä»»åŠ¡ç®¡ç†é¢æ¿é€»è¾‘
        let editingTask = { key: null, id: null };
        const manageModal = document.getElementById('task-manage-modal');
        const editInput = document.getElementById('edit-task-input');

        window.openTaskManage = (key, id, text) => {
            editingTask = { key, id };
            editInput.value = text;
            manageModal.classList.add('open');
            setTimeout(() => editInput.focus(), 100);
        };

        window.closeTaskManage = () => {
            manageModal.classList.remove('open');
            editingTask = { key: null, id: null };
        };

        window.saveEditedTask = () => {
            const newText = editInput.value.trim();
            if(newText && editingTask.id) {
                const tasks = currentState.customTasks[editingTask.key];
                const task = tasks.find(t => t.id === editingTask.id);
                if(task) {
                    task.text = newText;
                    if (CURRENT_YEAR === 2025) render2025(); else render2026(currentMonth2026);
                    save();
                }
            }
            closeTaskManage();
        };

        window.deleteCurrentTask = () => {
            if(confirm("ç¡®å®šåˆ é™¤ä»»åŠ¡ï¼Ÿ")) {
                const { key, id } = editingTask;
                currentState.customTasks[key] = currentState.customTasks[key].filter(t => t.id !== id);
                if (CURRENT_YEAR === 2025) render2025(); else render2026(currentMonth2026);
                save();
                closeTaskManage();
            }
        };

        // ================= æ•°æ®å­˜å– (ç»Ÿä¸€IDé€»è¾‘) =================
        function ensureStateStructure(s) {
            if (!s) return { done: [], notes: {}, customTasks: {} };
            if (!s.done) s.done = [];
            if (!s.notes) s.notes = {};
            if (!s.customTasks) s.customTasks = {}; 
            return s;
        }

        async function save() {
            updateProgress();
            // ä¿å­˜æ•´ä¸ª fullState åˆ° study_v2 (è¦†ç›–æ›´æ–°ï¼Œä¿æŒå…¼å®¹)
            localStorage.setItem('study_v2', JSON.stringify(fullState));
            if(isCloud) { 
                updateStatus('syncing'); 
                // ä½¿ç”¨å”¯ä¸€çš„ ID å­˜å‚¨æ‰€æœ‰å¹´ä»½æ•°æ®
                await supabaseClient.from('study_progress').upsert({ id: MY_SYNC_ID, data: fullState }); 
                updateStatus('online'); 
            }
        }

        // æ ¸å¿ƒï¼šæ³¨å…¥åˆå§‹è®¡åˆ’
        function inject2026Plan() {
            // å¦‚æœ 2026 ä»»åŠ¡ä¸ºç©ºï¼Œæˆ–è€…éƒ¨åˆ†ä¸ºç©ºï¼Œæˆ‘ä»¬å°è¯•åˆå¹¶
            // è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨â€œå¢é‡åˆå¹¶â€ç­–ç•¥ï¼šå¦‚æœå½“å¤©æ²¡æœ‰ä»»åŠ¡ï¼Œæˆ–è€…ä»»åŠ¡ä¸é‡å¤ï¼Œå°±æ·»åŠ 
            const existing = fullState["2026"].customTasks;
            
            Object.keys(PLAN_2026_INIT).forEach(dateKey => {
                if(!existing[dateKey]) existing[dateKey] = [];
                
                PLAN_2026_INIT[dateKey].forEach(initTask => {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡æœ¬çš„ä»»åŠ¡
                    const exists = existing[dateKey].some(t => t.text === initTask.text);
                    if(!exists) {
                        existing[dateKey].push(initTask);
                    }
                });
            });
        }

        async function loadCloud() { 
            updateStatus('syncing');
            // åªè¯»å–ä¸€ä¸ª ID
            const {data} = await supabaseClient.from('study_progress').select('data').eq('id', MY_SYNC_ID).single();
            
            if(data?.data) {
                const raw = data.data;
                // æ•°æ®è¿ç§»é€»è¾‘ï¼šå¦‚æœè¯»å–åˆ°çš„æ•°æ®æ²¡æœ‰ "2025" é”®ï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                if (!raw["2025"] && !raw["2026"]) {
                    fullState["2025"] = ensureStateStructure(raw);
                    fullState["2026"] = { done: [], notes: {}, customTasks: {} };
                } else {
                    if(raw["2025"]) fullState["2025"] = ensureStateStructure(raw["2025"]);
                    if(raw["2026"]) fullState["2026"] = ensureStateStructure(raw["2026"]);
                }
            } else {
                loadLocal(); // Fallback
            }

            inject2026Plan(); // æ³¨å…¥è®¡åˆ’
            currentState = fullState[CURRENT_YEAR.toString()];
            refresh();
            switchYear(CURRENT_YEAR); // Re-render
            updateStatus('online');
        }

        function loadLocal() { 
            // è¯»å–æœ¬åœ° study_v2
            const s = localStorage.getItem('study_v2');
            if(s) {
                const raw = JSON.parse(s);
                // æ£€æµ‹æ˜¯å¦å·²ç»æ˜¯æ–°ç»“æ„
                if (raw["2025"] || raw["2026"]) {
                    if(raw["2025"]) fullState["2025"] = ensureStateStructure(raw["2025"]);
                    if(raw["2026"]) fullState["2026"] = ensureStateStructure(raw["2026"]);
                } else {
                    fullState["2025"] = ensureStateStructure(raw);
                }
            }
            
            inject2026Plan(); // æ³¨å…¥è®¡åˆ’
            currentState = fullState[CURRENT_YEAR.toString()];
            refresh();
            switchYear(CURRENT_YEAR);
        }

        window.toggle = id => { const i = currentState.done.indexOf(id); i>-1 ? currentState.done.splice(i,1) : currentState.done.push(id); refresh(); save(); };

        function refresh() {
            document.querySelectorAll('.task-item').forEach(el => currentState.done.includes(el.dataset.id) ? el.classList.add('done') : el.classList.remove('done'));
            // æ›´æ–°ç¬”è®°å›¾æ ‡é¢œè‰²
            const keys = Object.keys(currentState.notes);
            keys.forEach(k => {
                const icon = document.getElementById(`icon-${k}`);
                if(icon) { icon.classList.add('text-orange-400', 'opacity-100'); icon.classList.remove('text-slate-400'); }
            });
            updateProgress();
        }

        function updateProgress() {
            const total = document.querySelectorAll('.task-item').length;
            let done = 0;
            document.querySelectorAll('.task-item').forEach(el => { if(el.classList.contains('done')) done++; });
            const p = total ? Math.round((done/total)*100) : 0;
            document.getElementById('progress-text').innerText = p + '%';
            document.getElementById('progress-fill').style.width = p + '%';
        }
        
        function updateSyncLabel() {
             const display = MY_SYNC_ID === DEFAULT_SYNC_ID ? 'LOCAL' : MY_SYNC_ID;
             const el = document.getElementById('sync-id-label');
             if(el) el.innerText = display;
        }

        // ================= è¾…åŠ©é€»è¾‘ =================
        function updateCountdown2025() {
            const diff = new Date("2025-12-20T00:00:00").getTime() - new Date().getTime();
            document.getElementById('days-left').innerText = Math.max(0, Math.ceil(diff / 86400000));
        }
        function updateCountdown2026() {
            const diff = new Date("2026-12-31T23:59:59").getTime() - new Date().getTime();
            document.getElementById('days-left').innerText = Math.max(0, Math.ceil(diff / 86400000));
        }

        // ================= ä»»åŠ¡æ·»åŠ  =================
        let addingKey = null;
        let selectedType = 't-work'; // é»˜è®¤
        
        window.openAddTaskModal = (key) => {
            addingKey = key;
            const modal = document.getElementById('add-task-modal');
            const container = document.getElementById('type-selector-container');
            
            // æ ¹æ®å¹´ä»½æ¸²æŸ“ä¸åŒçš„åˆ†ç±»é€‰é¡¹
            if(CURRENT_YEAR === 2025) {
                container.innerHTML = `
                    <div class="type-option" data-val="t-pol" onclick="selectType('t-pol', this)">æ”¿æ²»</div>
                    <div class="type-option" data-val="t-eng" onclick="selectType('t-eng', this)">è‹±è¯­</div>
                    <div class="type-option" data-val="t-art" onclick="selectType('t-art', this)">æ‰‹ç»˜</div>
                    <div class="type-option" data-val="t-the" onclick="selectType('t-the', this)">å²è®º</div>`;
                 selectType('t-pol', container.children[0]);
            } else {
                container.innerHTML = `
                    <div class="type-option" data-val="t-work" onclick="selectType('t-work', this)">å·¥ä½œ</div>
                    <div class="type-option" data-val="t-study" onclick="selectType('t-study', this)">å­¦ä¹ </div>
                    <div class="type-option" data-val="t-life" onclick="selectType('t-life', this)">ç”Ÿæ´»</div>
                    <div class="type-option" data-val="t-urgent" onclick="selectType('t-urgent', this)">ç´§æ€¥</div>`;
                selectType('t-work', container.children[0]);
            }
            
            modal.classList.add('open');
            document.getElementById('new-task-input').value = '';
            setTimeout(() => document.getElementById('new-task-input').focus(), 100);
        };

        window.selectType = (type, el) => {
            selectedType = type;
            document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.confirmAddTask = () => {
            const text = document.getElementById('new-task-input').value.trim();
            if(!text) return;
            if(!currentState.customTasks[addingKey]) currentState.customTasks[addingKey] = [];
            currentState.customTasks[addingKey].push({ id: `custom-${Date.now()}`, text: text, type: selectedType });
            document.getElementById('add-task-modal').classList.remove('open');
            refresh();
            if (CURRENT_YEAR === 2025) render2025(); else render2026(currentMonth2026);
            save();
        };

        window.deleteTask = (key, id) => {
            if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
            currentState.customTasks[key] = currentState.customTasks[key].filter(t => t.id !== id);
            if (CURRENT_YEAR === 2025) render2025(); else render2026(currentMonth2026);
            save();
        };

        // ================= ç¬”è®° & é«˜çº§åŠŸèƒ½ =================
        let curNoteKey = null, isEditMode = false;
        const editor = document.getElementById('note-editor');

        window.openNote = (key, highlight = null) => {
            curNoteKey = key; isEditMode = false;
            let title;
            if (key.startsWith('d')) {
                // 2025 format: d1, d2...
                title = `12æœˆ${key.replace('d','')}æ—¥`;
            } else {
                // 2026 format: 2026-1-22
                const parts = key.split('-');
                title = `${parts[1]}æœˆ${parts[2]}æ—¥`;
            }
            document.getElementById('modal-date-title').innerText = title;
            
            const content = currentState.notes[key];
            editor.innerHTML = content || '';
            
            if(!content) toggleEditMode(true); else setMode(false);
            document.getElementById('note-modal').classList.add('open');
            
            if(highlight) setTimeout(() => scrollToText(highlight), 300);
        };

        window.toggleEditMode = (force) => setMode(typeof force === 'boolean' ? force : !isEditMode);
        function setMode(edit) {
            isEditMode = edit; editor.contentEditable = edit;
            const tools = document.getElementById('editor-tools');
            const editBtn = document.getElementById('edit-btn');
            const saveBtn = document.getElementById('save-btn');
            
            if(edit) {
                tools.classList.remove('opacity-0', 'pointer-events-none');
                editBtn.classList.add('hidden'); saveBtn.classList.remove('hidden');
                document.getElementById('mode-badge').innerText = "ç¼–è¾‘ä¸­";
            } else {
                tools.classList.add('opacity-0', 'pointer-events-none');
                editBtn.classList.remove('hidden'); saveBtn.classList.add('hidden');
                document.getElementById('mode-badge').innerText = "æŸ¥çœ‹æ¨¡å¼";
            }
        }
        
        window.saveNote = () => {
            const v = editor.innerHTML;
            if(v && v !== '<br>') currentState.notes[curNoteKey] = v; else delete currentState.notes[curNoteKey];
            refresh(); save(); setMode(false);
        };
        window.closeModal = () => { document.querySelector('.modal-overlay.open').classList.remove('open'); if(isEditMode) saveNote(); };

        // æœç´¢é€»è¾‘
        window.toggleSearch = () => document.getElementById('search-modal').classList.toggle('open');
        window.handleSearch = (q) => {
            if(!q) return;
            const res = [];
            // æœç´¢å½“å‰é€‰å®šå¹´ä»½çš„æ•°æ®
            const notes = currentState.notes;
            const tasks = currentState.customTasks;
            
            Object.keys(notes).forEach(k => {
                if(notes[k].toLowerCase().includes(q.toLowerCase())) res.push({k, type:'ç¬”è®°', text: notes[k].replace(/<[^>]*>?/gm, '').substring(0,50)});
            });
            Object.keys(tasks).forEach(k => {
                tasks[k].forEach(t => {
                    if(t.text.toLowerCase().includes(q.toLowerCase())) res.push({k, type:'ä»»åŠ¡', text: t.text});
                })
            });
            
            document.getElementById('search-results').innerHTML = res.length ? res.map(r => `
                <div class="search-item" onclick="jumpTo('${r.k}')">
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>${r.k}</span><span>${r.type}</span>
                    </div>
                    <div class="text-sm font-bold text-slate-700">${r.text}</div>
                </div>`).join('') : '<div class="empty-state">æ— ç»“æœ</div>';
        };
        window.jumpTo = k => {
            document.getElementById('search-modal').classList.remove('open');
            openNote(k);
        };

        // åˆå§‹åŒ–ç¼–è¾‘å™¨äº‹ä»¶ (Markdown, å›¾ç‰‡ç‚¹å‡»)
        function initEditorEvents() {
            window.execCmd = (c, v) => { document.execCommand(c, false, v); editor.focus(); };
            window.insertCheckbox = () => execCmd('insertHTML', `<input type="checkbox"> `);
            window.cycleLineHeight = () => { lineHeightIdx=(lineHeightIdx+1)%3; localStorage.setItem('study_lh_idx', lineHeightIdx); applyLineHeight(); };
            
            editor.addEventListener('click', e => {
                if(e.target.tagName === 'IMG') {
                    document.getElementById('zoomed-img').src = e.target.src;
                    document.getElementById('img-zoom-modal').classList.add('open');
                }
            });
            // Markdown Trigger
            editor.addEventListener('keyup', e => {
                if(e.key === ' ') {
                    const sel = window.getSelection();
                    if(!sel.rangeCount) return;
                    const txt = sel.anchorNode.textContent;
                    if(txt.match(/^(\-|\*)\s$/)) { document.execCommand('delete',false); document.execCommand('delete',false); document.execCommand('insertUnorderedList'); }
                    if(txt.match(/^1\.\s$/)) { document.execCommand('delete',false); document.execCommand('delete',false); document.execCommand('delete',false); document.execCommand('insertOrderedList'); }
                }
            });
        }
        function applyLineHeight() { 
            lhClasses.forEach(c => editor.classList.remove(c)); 
            editor.classList.add(lhClasses[lineHeightIdx]); 
        }
        function updateStatus(s) { document.getElementById('cloud-status-badge').innerHTML = s==='online' ? `<span class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.6)]"></span> äº‘åŒæ­¥` : (s==='syncing' ? `<span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span> åŒæ­¥ä¸­` : `<span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> ç¦»çº¿`); }
        
        // ================= æ ¸å¿ƒä¿®æ”¹ï¼šID å¼¹çª—é€»è¾‘ =================
        window.changeSyncID = () => { 
            document.getElementById('sync-id-input').value = MY_SYNC_ID;
            document.getElementById('id-modal').classList.add('open');
            setTimeout(() => document.getElementById('sync-id-input').focus(), 100);
        };
        
        window.closeIdModal = () => document.getElementById('id-modal').classList.remove('open');
        
        window.saveSyncID = () => {
            const val = document.getElementById('sync-id-input').value.trim();
            if(val && val !== "") {
                MY_SYNC_ID = val;
                localStorage.setItem('study_sync_id', val);
                updateSyncLabel();
                if(isCloud) loadCloud();
            }
            closeIdModal();
        };

        // Scroll highlight helper
        function scrollToText(text) {
            if (!text) return;
            const editor = document.getElementById('note-editor');
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                if (node.nodeValue.toLowerCase().includes(text.toLowerCase())) {
                    const range = document.createRange();
                    range.selectNodeContents(node);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    node.parentElement.style.backgroundColor = '#fef08a';
                    setTimeout(() => node.parentElement.style.backgroundColor = '', 1500);
                    break;
                }
            }
        }

        init();
    </script>
</body>
</html>
